import{c as He,L as we}from"./lobby-DK9NN18H.js";class De{constructor(e,n=1e3/60){this.accumulatorMs=0,this.lastTime=0,this.rafId=null,this.running=!1,this.callbacks=e,this.fixedStepMs=n}start(){if(this.running)return;this.running=!0,this.lastTime=performance.now();const e=()=>{if(!this.running)return;const n=performance.now();let s=n-this.lastTime;for(s>1e3&&(s=this.fixedStepMs),this.lastTime=n,this.accumulatorMs+=s;this.accumulatorMs>=this.fixedStepMs;)this.callbacks.update(this.fixedStepMs),this.accumulatorMs-=this.fixedStepMs;this.callbacks.render(),this.rafId=requestAnimationFrame(e)};this.rafId=requestAnimationFrame(e)}stop(){this.running=!1,this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=null}}const Ae={left:["ArrowLeft"],right:["ArrowRight"],softDrop:["ArrowDown"],hardDrop:[" "],rotateCW:["x","X","ArrowUp"],rotateCCW:["z","Z"],hold:["c","C"],pause:["p","P"],restart:["r","R"]};class qe{constructor(e={}){this.onKeyDown=n=>{let s=!1;this.match(n,this.bindings.left)&&(this.state.left=!0,s=!0),this.match(n,this.bindings.right)&&(this.state.right=!0,s=!0),this.match(n,this.bindings.softDrop)&&(this.state.softDrop=!0,s=!0),this.match(n,this.bindings.hardDrop)&&(this.state.hardDrop=!0,s=!0),this.match(n,this.bindings.rotateCW)&&(this.state.rotateCW=!0,s=!0),this.match(n,this.bindings.rotateCCW)&&(this.state.rotateCCW=!0,s=!0),this.match(n,this.bindings.hold)&&(this.state.hold=!0,s=!0),this.match(n,this.bindings.pause)&&(this.state.pause=!0,s=!0),this.match(n,this.bindings.restart)&&(this.state.restart=!0,s=!0),s&&!me(n)&&n.preventDefault()},this.onKeyUp=n=>{let s=!1;this.match(n,this.bindings.left)&&(this.state.left=!1,s=!0),this.match(n,this.bindings.right)&&(this.state.right=!1,s=!0),this.match(n,this.bindings.softDrop)&&(this.state.softDrop=!1,s=!0),this.match(n,this.bindings.hardDrop)&&(this.state.hardDrop=!1,s=!0),this.match(n,this.bindings.rotateCW)&&(this.state.rotateCW=!1,s=!0),this.match(n,this.bindings.rotateCCW)&&(this.state.rotateCCW=!1,s=!0),this.match(n,this.bindings.hold)&&(this.state.hold=!1,s=!0),this.match(n,this.bindings.pause)&&(this.state.pause=!1,s=!0),this.match(n,this.bindings.restart)&&(this.state.restart=!1,s=!0),s&&!me(n)&&n.preventDefault()},this.bindings={...Ae,...e},this.state={left:!1,right:!1,softDrop:!1,hardDrop:!1,rotateCW:!1,rotateCCW:!1,hold:!1,pause:!1,restart:!1}}attach(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp)}detach(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}consume(e){const n=this.state[e];return this.state[e]=!1,n}match(e,n){return n.includes(e.key)}}function me(t){var s;const e=t.target;if(!e)return!1;const n=(s=e.tagName)==null?void 0:s.toLowerCase();return!!(n==="input"||n==="textarea"||n==="select"||e.isContentEditable)}const F={I:"#5dd1ff",O:"#ffd95d",T:"#b85dff",S:"#5dff9e",Z:"#ff5d87",J:"#5d83ff",L:"#ffa35d"},Ke={I:[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],O:[[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]]],T:[[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],S:[[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,0,0,0],[0,1,1,0],[1,1,0,0],[0,0,0,0]],[[1,0,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],Z:[[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[1,0,0,0],[0,0,0,0]]],J:[[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[1,1,0,0],[0,0,0,0]]],L:[[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[1,0,0,0],[0,0,0,0]],[[1,1,0,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]]]};function ee(t){return Ke[t.type][t.rotation]}function*We(){const t=["I","O","T","S","Z","J","L"];for(;;){const e=[...t];for(let n=e.length-1;n>0;n--){const s=Math.floor(Math.random()*(n+1));[e[n],e[s]]=[e[s],e[n]]}for(const n of e)yield n}}function je(t){const e=["I","O","T","S","Z","J","L"];function*n(){for(;;){const s=[...e];for(let o=s.length-1;o>0;o--){const a=Math.floor(t()*(o+1));[s[o],s[a]]=[s[a],s[o]]}for(const o of s)yield o}}return n()}function ze(t){let e=t|0||1;return je(()=>(e^=e<<13,e^=e>>>17,e^=e<<5,(e>>>0)%4294967295/4294967295))}const L=10,W=22;function Ue(){return Array.from({length:W},()=>Array(L).fill(0))}function X(t){const e=typeof t=="number"?ze(t):We(),n={field:Ue(),active:null,hold:null,holdLocked:!1,queue:[],bag:e,score:0,level:1,lines:0,gravityMs:1e3,gravityTimer:0,lockDelayMs:500,lockTimer:0,status:"playing"};return Se(n),te(n),n}function Se(t){for(;t.queue.length<5;)t.queue.push(t.bag.next().value)}function te(t){const e=t.queue.shift();Se(t);const n={type:e,rotation:0,x:3,y:0};if(j(t,n)){t.status="gameover";return}t.active=n,t.holdLocked=!1}function Ne(t,e){let n=e.y;for(;!j(t,{...e,y:n+1});)n++;return n}function J(t,e,n){if(!t.active)return!1;const s={...t.active,x:t.active.x+e,y:t.active.y+n};return j(t,s)?!1:(t.active=s,!0)}function ye(t,e){if(!t.active)return!1;const n=((t.active.rotation+e)%4+4)%4,s=Xe(t.active.type,t.active.rotation,n);for(const[o,a]of s){const i={...t.active,rotation:n,x:t.active.x+o,y:t.active.y+a};if(!j(t,i))return t.active=i,!0}return!1}function Xe(t,e,n){const s=[[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]]],o=[[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],[[0,0],[1,0],[-2,0],[1,-2],[-2,1]]];if(t==="O")return[[0,0]];const a=t==="I"?o:s,i=e===0&&n===1||e===1&&n===2||e===2&&n===3||e===3&&n===0?e%4:(e+3)%4;return a[i]}function j(t,e){const n=ee(e);for(let s=0;s<4;s++)for(let o=0;o<4;o++){if(!n[s][o])continue;const a=e.x+o,i=e.y+s;if(a<0||a>=L||i>=W||i>=0&&t.field[i][a])return!0}return!1}function Ye(t,e){if(t.status!=="playing")return;t.gravityTimer+=e;let n=!1;for(;t.gravityTimer>=t.gravityMs;)t.gravityTimer-=t.gravityMs,n=J(t,0,1)||n;n?t.lockTimer=0:t.active&&j(t,{...t.active,y:t.active.y+1})?(t.lockTimer+=e,t.lockTimer>=t.lockDelayMs&&(Ce(t),Ee(t),Re(t),te(t),t.lockTimer=0)):t.lockTimer=0}function Je(t){if(!t.active||t.holdLocked)return;const e=t.active.type;if(t.hold===null)t.hold=e,te(t);else{const n=t.hold;t.hold=e,t.active={type:n,rotation:0,x:3,y:0},j(t,t.active)&&(t.status="gameover")}t.holdLocked=!0}function Fe(t){t.active&&(t.active.y=Ne(t,t.active),Ce(t),Ee(t),Re(t),te(t),t.lockTimer=0)}function Ce(t){if(!t.active)return;const e=ee(t.active);let n=0;for(let s=0;s<4;s++)for(let o=0;o<4;o++){if(!e[s][o])continue;const a=t.active.x+o,i=t.active.y+s;i>=0&&i<W&&a>=0&&a<L&&(t.field[i][a]=t.active.type,i>=2&&n++)}n>0&&(t.score+=1),t.active=null}function Ee(t){let e=0;for(let n=W-1;n>=0;n--)t.field[n].every(s=>s!==0)&&(t.field.splice(n,1),t.field.unshift(Array(L).fill(0)),e++,n++);e>0&&(t.lines+=e,t.score+=Ze(e,t.level))}function Ze(t,e){return([0,100,300,500,800][t]??0)*e}function Re(t){t.level=Math.floor(t.lines/10)+1,t.gravityMs=Math.max(60,1e3-(t.level-1)*80)}function ke(t){const e=X();Object.assign(t,e)}function Te(t,e){if(!(e<=0)){for(let n=0;n<e;n++){const s=Math.floor(Math.random()*L);t.field.shift();const o=Array.from({length:L},(a,i)=>i===s?0:"Z");t.field.push(o)}for(let n=0;n<2;n++)for(let s=0;s<L;s++)if(t.field[n][s]!==0){t.status="gameover";return}}}const C=32;function Qe(t,e){Ve(t,e.board),et(t,e.next),tt(t,e.hold),e.scoreEl.textContent=String(t.score),e.levelEl.textContent=String(t.level),e.linesEl.textContent=String(t.lines)}function Ve(t,e){const n=e.getContext("2d");n.clearRect(0,0,e.width,e.height),n.fillStyle="#111433";for(let s=0;s<W-2;s++)for(let o=0;o<L;o++)n.fillRect(o*C+1,s*C+1,C-2,C-2);for(let s=2;s<W;s++)for(let o=0;o<L;o++){const a=t.field[s][o];a&&he(n,o,s-2,F[a])}if(t.active){const s=ee(t.active);for(let o=0;o<4;o++)for(let a=0;a<4;a++){if(!s[o][a])continue;const i=t.active.x+a,c=t.active.y+o-2;c>=0&&he(n,i,c,F[t.active.type])}}}function he(t,e,n,s){const a=e*C,i=n*C;t.fillStyle=s,ge(t,a+1,i+1,C-2,C-2,8),t.fill();const c=t.createLinearGradient(a,i,a,i+C);c.addColorStop(0,"rgba(255,255,255,0.25)"),c.addColorStop(1,"rgba(0,0,0,0.25)"),t.fillStyle=c,ge(t,a+1,i+1,C-2,C-2,8),t.fill()}function ge(t,e,n,s,o,a){t.beginPath(),t.moveTo(e+a,n),t.arcTo(e+s,n,e+s,n+o,a),t.arcTo(e+s,n+o,e,n+o,a),t.arcTo(e,n+o,e,n,a),t.arcTo(e,n,e+s,n,a),t.closePath()}function et(t,e){const n=e.getContext("2d");n.clearRect(0,0,e.width,e.height);const s=t.queue.slice(0,3),o=12,a=Math.floor((e.height-o*2)/s.length),c=Math.max(12,Math.floor(a/4*.95)),r=4*c,d=Math.floor((e.width-r)/2);s.forEach((f,E)=>{const k=o+E*a+Math.floor((a-r)/2);$e(n,f,d,k,c)})}function tt(t,e){const n=e.getContext("2d");if(n.clearRect(0,0,e.width,e.height),!t.hold)return;const s=18,o=4*s,a=Math.floor((e.width-o)/2),i=Math.floor((e.height-o)/2);$e(n,t.hold,a,i,s)}function $e(t,e,n,s,o){const a=F[e],i={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],O:[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],T:[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],S:[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],Z:[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],J:[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],L:[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]]};let c=4,r=4,d=-1,f=-1;for(let h=0;h<4;h++)for(let I=0;I<4;I++)i[e][h][I]&&(I<c&&(c=I),h<r&&(r=h),I>d&&(d=I),h>f&&(f=h));const E=d-c+1,R=f-r+1,k=Math.floor((4-E)/2)*o-c*o,Y=Math.floor((4-R)/2)*o-r*o;for(let h=0;h<4;h++)for(let I=0;I<4;I++)i[e][h][I]&&(t.fillStyle=a,t.fillRect(n+k+I*o+1,s+Y+h*o+1,o-2,o-2))}class _e{constructor(e,n){this.channel=null,this.roomId=null,this.supa=He(e,n,{realtime:{params:{eventsPerSecond:20}},auth:{persistSession:!1,autoRefreshToken:!1}}),this.userId=crypto.randomUUID()}join(e,n,s){this.roomId=e,console.log(`[Realtime] Joining room: ${e} as ${s} (${this.userId})`);const o=this.supa.channel(`room:${e}`,{config:{broadcast:{ack:!0,self:!1}}});o.on("broadcast",{event:"message"},a=>{const i=a.payload;if(console.log("[Realtime] Received broadcast message:",i.type,i.payload),console.log("[Realtime] From channel:",this.roomId),console.log("[Realtime] Channel subscription status:",o.state),i.type==="join"||i.type==="leave"){const c=i.payload.userId;if(console.log(`[Realtime] Message userId: ${c}, My userId: ${this.userId}`),c===this.userId){console.log("[Realtime] Ignoring own message");return}}if(i.type==="ready"){const c=i.payload.userId;console.log(`[Realtime] Ready message - userId: ${c}, My userId: ${this.userId}`),console.log("[Realtime] Passing ready message to handler")}try{n(i)}catch(c){console.error("[Realtime] Error processing message:",c)}}),o.subscribe(a=>{console.log(`[Realtime] Channel status: ${a}`),a==="SUBSCRIBED"&&(console.log("[Realtime] Successfully subscribed, sending join message"),this.send({type:"join",payload:{userId:this.userId,name:s}}))}),this.channel=o}leave(){this.channel&&(this.send({type:"leave",payload:{userId:this.userId}}),this.supa.removeChannel(this.channel),this.channel=null),this.roomId=null}send(e){if(!this.channel){console.warn("[Realtime] Cannot send - no channel");return}console.log("[Realtime] Sending message:",e.type,e.payload),console.log("[Realtime] To room:",this.roomId),console.log("[Realtime] Channel state:",this.channel.state),this.channel.send({type:"broadcast",event:"message",payload:e}).then(()=>console.log("[Realtime] Message sent successfully")).catch(n=>console.error("[Realtime] Error sending message:",n))}getUserId(){return this.userId}}const Me="tetris_highscores",Z=window.__TETRIS_API__;function de(){const e=window.__SUPABASE__;if(!(!e||!e.url||!e.anonKey))return e}const ne=10;function A(){try{const t=de();if(t!=null&&t.url&&(t!=null&&t.anonKey)){const s=new URL(`${t.url.replace(/\/$/,"")}/rest/v1/scores`);s.searchParams.set("select","name,score,level,lines,created_at"),s.searchParams.set("order","score.desc,created_at.desc"),s.searchParams.set("limit","10");const o=new XMLHttpRequest;if(o.open("GET",s.toString(),!1),o.setRequestHeader("apikey",t.anonKey),o.setRequestHeader("Authorization",`Bearer ${t.anonKey}`),o.send(),o.status>=200&&o.status<300)return JSON.parse(o.responseText).map(c=>({name:c.name,score:c.score,level:c.level,lines:c.lines,date:c.created_at??new Date().toISOString()}))}if(Z){const s=new XMLHttpRequest;if(s.open("GET",`${Z}/scores?limit=10`,!1),s.send(),s.status>=200&&s.status<300)return JSON.parse(s.responseText).map(i=>({name:i.name,score:i.score,level:i.level,lines:i.lines,date:i.createdAt??i.created_at??new Date().toISOString()}))}const e=localStorage.getItem(Me);if(!e)return[];const n=JSON.parse(e);return Array.isArray(n)?n.filter(Be).slice(0,ne):[]}catch{return[]}}function nt(t){const e=t.filter(Be).sort((n,s)=>s.score-n.score||s.date.localeCompare(n.date)).slice(0,ne);localStorage.setItem(Me,JSON.stringify(e))}function ot(t,e=A()){var s;if(e.length<ne)return!0;const n=((s=e[e.length-1])==null?void 0:s.score)??0;return t>n}function st(t,e,n){const s=new Date().toISOString(),o={name:t.trim()||"Anonymous",score:e,level:n==null?void 0:n.level,lines:n==null?void 0:n.lines,date:s};try{const r=de();if(r!=null&&r.url&&(r!=null&&r.anonKey)){const d=new XMLHttpRequest;if(d.open("POST",`${r.url.replace(/\/$/,"")}/rest/v1/scores`,!1),d.setRequestHeader("Content-Type","application/json"),d.setRequestHeader("apikey",r.anonKey),d.setRequestHeader("Authorization",`Bearer ${r.anonKey}`),d.setRequestHeader("Prefer","return=representation"),d.send(JSON.stringify({name:o.name,score:o.score,level:o.level??1,lines:o.lines??0})),d.status>=200&&d.status<300){const[f]=JSON.parse(d.responseText);f!=null&&f.created_at&&(o.date=f.created_at),typeof(f==null?void 0:f.level)=="number"&&(o.level=f.level),typeof(f==null?void 0:f.lines)=="number"&&(o.lines=f.lines)}}else if(Z){const d=new XMLHttpRequest;d.open("POST",`${Z}/scores`,!1),d.setRequestHeader("Content-Type","application/json"),d.send(JSON.stringify({name:o.name,score:o.score,level:o.level,lines:o.lines}))}}catch{}const a=A();a.push(o),a.sort((r,d)=>d.score-r.score||d.date.localeCompare(r.date));const i=a.slice(0,ne);return nt(i),{rank:i.findIndex(r=>r===o)+1||i.findIndex(r=>r.score===e)+1||-1,entries:i}}function Le(t,e=A()){t.innerHTML=at(e)}function Be(t){return t&&typeof t.name=="string"&&typeof t.score=="number"&&typeof t.date=="string"}function at(t){if(t.length===0)return'<div class="scoreboard__empty">No high scores yet. Be the first!</div>';const e='<div class="scoreboard__header"><span class="rank">#</span><span class="name">Name</span><span class="score">Score</span><span class="level">Level</span><span class="lines">Lines</span><span class="date">Date</span></div>',n=t.map((s,o)=>{const a=o+1,i=rt(s.date),c=typeof s.level=="number"?s.level:"-",r=typeof s.lines=="number"?s.lines:"-";return`<div class="scoreboard__row"><span class="rank">${a}</span><span class="name">${it(s.name)}</span><span class="score">${s.score.toLocaleString()}</span><span class="level">${c}</span><span class="lines">${r}</span><span class="date">${i}</span></div>`}).join("");return`<div class="scoreboard__wrap"><div class="scoreboard__title">High Scores</div>${e}${n}</div>`}function it(t){return t.replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[e])}function rt(t){const e=new Date(t),n=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),a=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0");return`${n}-${s}-${o} ${a}:${i}`}function Et(t){var i,c;const e=de(),n=(t||"").trim();if(!n)return null;try{if(e!=null&&e.url&&(e!=null&&e.anonKey)){const r=new URL(`${e.url.replace(/\/$/,"")}/rest/v1/scores`);r.searchParams.set("select","score"),r.searchParams.set("name",`eq.${encodeURIComponent(n)}`),r.searchParams.set("order","score.desc"),r.searchParams.set("limit","1");const d=new XMLHttpRequest;if(d.open("GET",r.toString(),!1),d.setRequestHeader("apikey",e.anonKey),d.setRequestHeader("Authorization",`Bearer ${e.anonKey}`),d.send(),!(d.status>=200&&d.status<300))return null;const f=JSON.parse(d.responseText),E=(i=f==null?void 0:f[0])==null?void 0:i.score;if(typeof E!="number")return null;const R=new URL(`${e.url.replace(/\/$/,"")}/rest/v1/scores`);R.searchParams.set("select","score"),R.searchParams.set("score",`gt.${E}`),R.searchParams.set("limit","1");const k=new XMLHttpRequest;k.open("GET",R.toString(),!1),k.setRequestHeader("apikey",e.anonKey),k.setRequestHeader("Authorization",`Bearer ${e.anonKey}`),k.setRequestHeader("Prefer","count=exact"),k.send();const Y=k.getResponseHeader("Content-Range");if(!Y)return 1;const h=parseInt(Y.split("/")[1]||"0",10);return isFinite(h)?h+1:1}}catch{}const s=A(),o=(c=s.filter(r=>r.name===n).sort((r,d)=>d.score-r.score)[0])==null?void 0:c.score;return typeof o!="number"?null:s.filter(r=>r.score>o).length+1}const Ge=document.getElementById("board"),lt=document.getElementById("next"),ct=document.getElementById("hold"),dt=document.getElementById("score"),ut=document.getElementById("level"),ft=document.getElementById("lines"),B=document.getElementById("btn-pause"),pt=document.getElementById("btn-restart"),O=document.getElementById("scoreboard"),G=document.getElementById("opponent"),z=document.getElementById("room-id"),Q=document.getElementById("room-label"),oe=document.getElementById("btn-join"),se=document.getElementById("btn-leave"),H=document.getElementById("btn-ready"),x=document.getElementById("btn-start"),ae=document.getElementById("btn-lobby"),ie=document.getElementById("btn-create"),re=document.getElementById("btn-close-lobby"),U=document.getElementById("lobby"),xe=document.getElementById("room-list"),le=document.getElementById("nickname"),mt={board:Ge,next:lt,hold:ct,scoreEl:dt,levelEl:ut,linesEl:ft},$=new qe;$.attach();const l=X();let g=!0,be=l.status,M=!1,u=null,b=null,ve=0,P=!1,q=null,S=!1,D=(localStorage.getItem("tetris_nick")||"").trim()||"Anonymous",m=null,y=!1,w=!1,p=null;setTimeout(()=>_(),100);B.addEventListener("click",()=>ue());pt.addEventListener("click",()=>{ke(l),g=!1,B.textContent="Pause"});oe==null||oe.addEventListener("click",()=>{var s;const e=window.__SUPABASE__,n=(((s=z==null?void 0:z.value)==null?void 0:s.trim())||localStorage.getItem("tetris_room")||"").trim();!(e!=null&&e.url)||!(e!=null&&e.anonKey)||!n||(u&&u.leave(),u=new _e(e.url,e.anonKey),u.join(n,o=>{if(o.type==="state"){const a=o.payload;console.log("[Game] Received state from opponent"),b=a,a.attack&&a.attack>0&&(console.log(`[Game] Receiving ${a.attack} attack lines from opponent!`),Te(l,a.attack),Oe(a.attack)),a.status==="gameover"&&l.status==="playing"&&(console.log("[Game] Opponent lost! You win!"),Pe(),g=!0,M=!1,B.textContent="Game Over"),N()}else if(o.type==="host_info"){const a=o.payload;console.log("[Game] Received host info:",a),!y&&a.name&&(m=a.name,w=!0,_(),v())}else if(o.type==="leave")o.payload.userId!==u.getUserId()&&(console.log(`[Game] Opponent left: ${m}`),K(`${m||"Opponent"} left the room`),m=null,w=!1,S=!1,b=null,N(),_(),v(),y&&p&&p.updatePlayers(1));else if(o.type==="join")o.payload.userId!==u.getUserId()&&(m=o.payload.name||"Guest",w=!0,_(),v(),console.log(`[Game] Opponent joined: ${m}`),K(`${m} joined the room!`),y&&p&&p.updatePlayers(2),y&&(console.log("[Game] Sending host info to guest"),u==null||u.send({type:"host_info",payload:{userId:u.getUserId(),name:D}})));else if(o.type==="ready"){console.log("[Game] Received ready event:",o.payload);const a=u.getUserId();console.log(`[Game] My userId: ${a}, Event userId: ${o.payload.userId}`),o.payload.userId!==a?(S=o.payload.ready,console.log(`[Game] Opponent ready status updated: ${S}`),v(),S?(console.log("[Game] Opponent is ready!"),K(`${m||"Opponent"} is ready!`),V(!0)):(console.log("[Game] Opponent is not ready"),V(!1))):console.log("[Game] Ignoring own ready event")}else if(o.type==="start"){const a=performance.now(),i=Math.max(0,o.payload.at-a-4e3);setTimeout(()=>{fe(()=>{Object.assign(l,X(o.payload.seed)),g=!1,M=!0,B.textContent="Pause"})},i)}},D),Q&&(Q.textContent=`Room: ${n}`),localStorage.removeItem("tetris_room"),_(),v())});se==null||se.addEventListener("click",()=>{u==null||u.leave(),b=null,m=null,S=!1,P=!1,M=!1,g=!0,w=!1,y&&p&&p.closeRoom(),p=null,y=!1,N(),_(),v(),localStorage.removeItem("tetris_room"),localStorage.removeItem("tetris_room_title"),localStorage.removeItem("tetris_room_created"),window.location.href="../multi/"});H==null||H.addEventListener("click",()=>{if(P=!P,console.log(`[Game] Ready button clicked, ready: ${P}, isHost: ${y}`),y)v();else{H.textContent=P?"Ready ✔":"Ready";const t=(u==null?void 0:u.getUserId())||"unknown";console.log(`[Game] Sending ready status: ${P}, userId: ${t}`),u==null||u.send({type:"ready",payload:{userId:t,ready:P}}),v()}});x==null||x.addEventListener("click",()=>{if(!w||!S)return;const t=Math.floor(Math.random()*2147483647),e=performance.now()+5e3;u==null||u.send({type:"start",payload:{seed:t,at:e}}),fe(()=>{Object.assign(l,X(t)),g=!1,M=!0,B.textContent="Pause"})});ae==null||ae.addEventListener("click",()=>{const e=window.__SUPABASE__;!(e!=null&&e.url)||!(e!=null&&e.anonKey)||!U||(U.style.display=U.style.display==="none"?"block":"none",q||(q=new we(e.url,e.anonKey),q.onUpdate=n=>yt(n),q.join((le==null?void 0:le.value)||"Anonymous")))});re==null||re.addEventListener("click",()=>{U&&(U.style.display="none")});ie==null||ie.addEventListener("click",()=>{if(!q)return;const t=q.createRoom("Room");z&&(z.value=t)});function yt(t){xe&&(xe.innerHTML=t.map(e=>`<div class="row" style="justify-content:space-between;"><span>${e.id} • ${e.host}</span><span>${e.players}/${e.max}</span></div>`).join(""))}function ue(){g=!g,B.textContent=g?"Resume":"Pause"}function v(){!x||!H||(y?(H.style.display="none",x.style.display="inline-block",w&&S?(x.disabled=!1,x.style.opacity="1",x.style.cursor="pointer",x.textContent="Start"):(x.disabled=!0,x.style.opacity="0.5",x.style.cursor="not-allowed",x.textContent=w?"Waiting Ready...":"Waiting for player...")):(x.style.display="none",H.style.display="inline-block"))}function _(){const t=document.getElementById("my-name");t&&(t.textContent=D);const e=document.getElementById("opponent-name");e&&(m?(e.textContent=m,S&&(e.textContent+=" ✅")):e.textContent="Waiting for opponent...")}function V(t){const e=document.getElementById("opponent-name");e&&m&&(e.textContent=m+(t?" ✅":""))}function K(t){const e=document.createElement("div");e.style.cssText=`
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: #2a2f66;
    color: #e6e9ff;
    padding: 12px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 1001;
    animation: slideIn 0.3s ease-out;
  `,e.textContent=t;const n=document.createElement("style");n.textContent=`
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
  `,document.head.appendChild(n),document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",e.style.transition="opacity 0.3s",setTimeout(()=>{document.body.removeChild(e)},300)},3e3)}function ht(t){const e=document.createElement("div");if(e.style.cssText=`
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 200, 0, 0.9);
    color: white;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 20px;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 1500;
    animation: slideUp 0.3s ease-out;
  `,e.textContent=`💥 ${t}줄 공격! 💥`,!document.getElementById("attack-sent-style")){const n=document.createElement("style");n.id="attack-sent-style",n.textContent=`
      @keyframes slideUp {
        from { transform: translateX(-50%) translateY(20px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }
    `,document.head.appendChild(n)}document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",e.style.transition="opacity 0.3s",setTimeout(()=>{document.body.removeChild(e)},300)},1e3)}function Oe(t){const e=document.createElement("div");if(e.style.cssText=`
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 0, 0, 0.9);
    color: white;
    padding: 20px 40px;
    border-radius: 12px;
    font-size: 24px;
    font-weight: bold;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    z-index: 1500;
    animation: attackPulse 0.5s ease-out;
  `,e.textContent=`⚠️ ${t}줄 공격 받음! ⚠️`,!document.getElementById("attack-style")){const n=document.createElement("style");n.id="attack-style",n.textContent=`
      @keyframes attackPulse {
        0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 0.9; }
      }
    `,document.head.appendChild(n)}document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",e.style.transition="opacity 0.3s",setTimeout(()=>{document.body.removeChild(e)},300)},1500)}function Pe(){const t=document.createElement("div");t.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: grid;
    place-items: center;
    z-index: 3000;
  `;const e=document.createElement("div");if(e.style.cssText=`
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px 60px;
    border-radius: 20px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    animation: victoryBounce 0.5s ease-out;
  `,e.innerHTML=`
    <h1 style="font-size: 48px; margin: 0 0 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">🎉 승리! 🎉</h1>
    <p style="font-size: 20px; margin: 0 0 10px;">상대방이 게임오버 되었습니다!</p>
    <p style="font-size: 16px; margin: 0 0 30px; opacity: 0.9;">최종 점수: ${l.score}</p>
    <button id="btn-victory-leave" style="background: white; color: #667eea; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">로비로 돌아가기</button>
  `,!document.getElementById("victory-style")){const s=document.createElement("style");s.id="victory-style",s.textContent=`
      @keyframes victoryBounce {
        0% { transform: scale(0.5); opacity: 0; }
        60% { transform: scale(1.1); }
        100% { transform: scale(1); opacity: 1; }
      }
    `,document.head.appendChild(s)}t.appendChild(e),document.body.appendChild(t);const n=document.getElementById("btn-victory-leave");n==null||n.addEventListener("click",()=>{window.location.href="../multi/"})}function gt(){const t=document.createElement("div");t.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: grid;
    place-items: center;
    z-index: 3000;
  `;const e=document.createElement("div");if(e.style.cssText=`
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 40px 60px;
    border-radius: 20px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    animation: defeatFade 0.5s ease-out;
  `,e.innerHTML=`
    <h1 style="font-size: 48px; margin: 0 0 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">😢 패배 😢</h1>
    <p style="font-size: 20px; margin: 0 0 10px;">게임 오버!</p>
    <p style="font-size: 16px; margin: 0 0 30px; opacity: 0.9;">최종 점수: ${l.score}</p>
    <button id="btn-defeat-leave" style="background: white; color: #f5576c; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">로비로 돌아가기</button>
  `,!document.getElementById("defeat-style")){const s=document.createElement("style");s.id="defeat-style",s.textContent=`
      @keyframes defeatFade {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
      }
    `,document.head.appendChild(s)}t.appendChild(e),document.body.appendChild(t);const n=document.getElementById("btn-defeat-leave");n==null||n.addEventListener("click",()=>{window.location.href="../multi/"})}function fe(t){const e=["3","2","1","GO!"];let n=0;const s=()=>{if(n>=e.length){t();return}const o=document.createElement("div");if(o.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 120px;
      font-weight: 900;
      color: #ffd95d;
      text-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 2000;
      animation: countPulse 1s ease-out;
      pointer-events: none;
    `,o.textContent=e[n],!document.getElementById("countdown-style")){const a=document.createElement("style");a.id="countdown-style",a.textContent=`
        @keyframes countPulse {
          0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
          20% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
          40% { transform: translate(-50%, -50%) scale(1); }
          100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        }
      `,document.head.appendChild(a)}document.body.appendChild(o),setTimeout(()=>{document.body.removeChild(o)},1e3),n++,n<e.length?setTimeout(s,1e3):setTimeout(t,1e3)};s()}function xt(){if($.consume("pause")&&ue(),$.consume("restart")&&(ke(l),g=!1,B.textContent="Pause"),g||l.status!=="playing")return;const t=$.consume("left"),e=$.consume("right");t&&J(l,-1,0),e&&J(l,1,0),$.consume("softDrop")&&J(l,0,1),$.consume("rotateCW")&&ye(l,1),$.consume("rotateCCW")&&ye(l,-1),$.consume("hardDrop")&&Fe(l),$.consume("hold")&&Je(l)}const bt=new De({update:t=>{xt(),!g&&M&&Ye(l,t),St(),be!==l.status&&(l.status==="gameover"&&wt(),be=l.status)},render:()=>Qe(l,mt)});bt.start();const T=localStorage.getItem("tetris_room"),ce=localStorage.getItem("tetris_room_title");T&&window.location.pathname.includes("/game/")&&setTimeout(()=>{const e=window.__SUPABASE__;if(e!=null&&e.url&&(e!=null&&e.anonKey)){console.log(`[Game] Auto-joining room: ${T}`),u&&u.leave(),u=new _e(e.url,e.anonKey),u.join(T,o=>{if(o.type==="state"){const a=o.payload;console.log("[Game] Received state from opponent"),b=a,a.attack&&a.attack>0&&(console.log(`[Game] Receiving ${a.attack} attack lines from opponent!`),Te(l,a.attack),Oe(a.attack)),a.status==="gameover"&&l.status==="playing"&&(console.log("[Game] Opponent lost! You win!"),Pe(),g=!0,M=!1,B.textContent="Game Over"),N()}else if(o.type==="host_info"){const a=o.payload;console.log("[Game] Received host info:",a),!y&&a.name&&(m=a.name,w=!0,_(),v())}else if(o.type==="leave")o.payload.userId!==u.getUserId()&&(console.log(`[Game] Opponent left: ${m}`),K(`${m||"Opponent"} left the room`),m=null,w=!1,S=!1,b=null,N(),_(),v(),y&&p&&p.updatePlayers(1));else if(o.type==="join")o.payload.userId!==u.getUserId()&&(m=o.payload.name||"Guest",w=!0,_(),v(),console.log(`[Game] Opponent joined: ${m}`),K(`${m} joined the room!`),y&&p&&p.updatePlayers(2),y&&(console.log("[Game] Sending host info to guest"),u==null||u.send({type:"host_info",payload:{userId:u.getUserId(),name:D}})));else if(o.type==="ready"){console.log("[Game] Received ready event:",o.payload);const a=u.getUserId();console.log(`[Game] My userId: ${a}, Event userId: ${o.payload.userId}`),o.payload.userId!==a?(S=o.payload.ready,console.log(`[Game] Opponent ready status updated: ${S}`),v(),S?(console.log("[Game] Opponent is ready!"),K(`${m||"Opponent"} is ready!`),V(!0)):(console.log("[Game] Opponent is not ready"),V(!1))):console.log("[Game] Ignoring own ready event")}else if(o.type==="start"){const a=performance.now(),i=Math.max(0,o.payload.at-a-4e3);setTimeout(()=>{fe(()=>{Object.assign(l,X(o.payload.seed)),g=!1,M=!0,B.textContent="Pause"})},i)}},D);const n=localStorage.getItem("tetris_room_title")||T;Q&&(Q.textContent=`Room: ${n}`),y=localStorage.getItem("tetris_room_created")==="true",p||(p=new we(e.url,e.anonKey),p.join(D),y&&ce&&(console.log("[Game] Host maintaining room in lobby:",T),p.myRoomId=T,p.rooms.set(T,{id:T,host:D,title:ce,players:1,max:2,updatedAt:Date.now()}),p.isSubscribed&&p.updatePlayers(1)),p.onUpdate=o=>{const a=o.find(i=>i.id===T);a?(console.log("[Game] Room status:",a),y&&w&&(p==null||p.updatePlayers(2))):y&&ce&&(console.log("[Game] Room not found in lobby, maintaining it..."),p&&(p.myRoomId=T,p.updatePlayers(w?2:1)))}),_(),v()}},500);const vt="https://chbibdnqynilfuczbygg.supabase.co",It="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoYmliZG5xeW5pbGZ1Y3pieWdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MDc0OTQsImV4cCI6MjA3MDI4MzQ5NH0.VuwTKXiU1Yx4C_fQCIp5X20m8SupxBkCKhQzN7Vqe20";window.__SUPABASE__={url:vt,anonKey:It};O&&Le(O,A());pe();window.addEventListener("resize",pe);window.__tetris={getStatus:()=>l.status,isPaused:()=>g,pause:()=>{g||ue()}};window.addEventListener("beforeunload",()=>{y&&p&&p.closeRoom()});function wt(){const t=l.score,e=A();if(u&&M&&b&&b.status==="playing"&&(console.log("[Game] You lost! Opponent wins!"),gt()),ot(t,e)){const n=(localStorage.getItem("tetris_player_name")||"").trim(),s=(localStorage.getItem("tetris_nick")||"").trim();st(n||s||"Anonymous",t,{level:l.level,lines:l.lines})}O&&(Le(O,A()),pe());try{window.dispatchEvent(new CustomEvent("tetris:score-updated"))}catch{}}function pe(){if(!O)return;const t=16,e=window.innerHeight,n=Ge.getBoundingClientRect(),s=Math.max(120,e-(n.bottom+t)-t);O.style.maxHeight=`${s}px`,O.style.overflowY="auto",document.body.style.paddingBottom=`${Math.ceil(O.getBoundingClientRect().height)+t}px`}let Ie=0;function St(){if(!u||!M)return;const t=performance.now();if(t-Ie<200||(Ie=t,!l))return;const e=Math.max(0,l.lines-ve);ve=l.lines;const n=e;n>0&&M&&(console.log(`[Game] Sending ${n} attack lines to opponent!`),ht(n));const s={field:l.field.map(o=>o.map(a=>a?1:0)),active:l.active?{type:l.active.type,x:l.active.x,y:l.active.y,rotation:l.active.rotation}:null,score:l.score,level:l.level,lines:l.lines,status:l.status,attack:n>0?n:void 0};u.send({type:"state",payload:s})}function N(){if(!G)return;const t=G.getContext("2d");if(t.clearRect(0,0,G.width,G.height),!b){const a=Math.floor((G.width-320)/2),i=Math.floor((G.height-20*32)/2);t.strokeStyle="#1f2347",t.lineWidth=1;for(let c=0;c<20;c++)for(let r=0;r<10;r++)t.strokeRect(a+r*32,i+c*32,32,32);return}const e=32,n=Math.floor((G.width-10*e)/2),s=Math.floor((G.height-20*e)/2);t.strokeStyle="#1f2347",t.lineWidth=1;for(let o=0;o<20;o++)for(let a=0;a<10;a++)t.strokeRect(n+a*e,s+o*e,e,e);for(let o=2;o<b.field.length;o++)for(let a=0;a<b.field[0].length;a++)b.field[o][a]&&(t.fillStyle="#6ea8fe",t.fillRect(n+a*e+1,s+(o-2)*e+1,e-2,e-2));if(b.active){const o=b.active,a=o.type,i=o.rotation,c=ee({type:a,rotation:i,x:o.x,y:o.y}),r=F[a];t.fillStyle=r;for(let d=0;d<c.length;d++)for(let f=0;f<c[d].length;f++)if(c[d][f]){const E=o.x+f,R=o.y+d;R>=2&&E>=0&&E<10&&t.fillRect(n+E*e+1,s+(R-2)*e+1,e-2,e-2)}}}export{Et as c,A as l};
