class ne{constructor(t,n=1e3/60){this.accumulatorMs=0,this.lastTime=0,this.rafId=null,this.running=!1,this.callbacks=t,this.fixedStepMs=n}start(){if(this.running)return;this.running=!0,this.lastTime=performance.now();const t=()=>{if(!this.running)return;const n=performance.now();let s=n-this.lastTime;for(s>1e3&&(s=this.fixedStepMs),this.lastTime=n,this.accumulatorMs+=s;this.accumulatorMs>=this.fixedStepMs;)this.callbacks.update(this.fixedStepMs),this.accumulatorMs-=this.fixedStepMs;this.callbacks.render(),this.rafId=requestAnimationFrame(t)};this.rafId=requestAnimationFrame(t)}stop(){this.running=!1,this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=null}}const A={left:["ArrowLeft"],right:["ArrowRight"],softDrop:["ArrowDown"],hardDrop:[" "],rotateCW:["x","X","ArrowUp"],rotateCCW:["z","Z"],hold:["c","C"],pause:["p","P"],restart:["r","R"]};class se{constructor(t={}){this.onKeyDown=n=>{let s=!1;this.match(n,this.bindings.left)&&(this.state.left=!0,s=!0),this.match(n,this.bindings.right)&&(this.state.right=!0,s=!0),this.match(n,this.bindings.softDrop)&&(this.state.softDrop=!0,s=!0),this.match(n,this.bindings.hardDrop)&&(this.state.hardDrop=!0,s=!0),this.match(n,this.bindings.rotateCW)&&(this.state.rotateCW=!0,s=!0),this.match(n,this.bindings.rotateCCW)&&(this.state.rotateCCW=!0,s=!0),this.match(n,this.bindings.hold)&&(this.state.hold=!0,s=!0),this.match(n,this.bindings.pause)&&(this.state.pause=!0,s=!0),this.match(n,this.bindings.restart)&&(this.state.restart=!0,s=!0),s&&!x(n)&&n.preventDefault()},this.onKeyUp=n=>{let s=!1;this.match(n,this.bindings.left)&&(this.state.left=!1,s=!0),this.match(n,this.bindings.right)&&(this.state.right=!1,s=!0),this.match(n,this.bindings.softDrop)&&(this.state.softDrop=!1,s=!0),this.match(n,this.bindings.hardDrop)&&(this.state.hardDrop=!1,s=!0),this.match(n,this.bindings.rotateCW)&&(this.state.rotateCW=!1,s=!0),this.match(n,this.bindings.rotateCCW)&&(this.state.rotateCCW=!1,s=!0),this.match(n,this.bindings.hold)&&(this.state.hold=!1,s=!0),this.match(n,this.bindings.pause)&&(this.state.pause=!1,s=!0),this.match(n,this.bindings.restart)&&(this.state.restart=!1,s=!0),s&&!x(n)&&n.preventDefault()},this.bindings={...A,...t},this.state={left:!1,right:!1,softDrop:!1,hardDrop:!1,rotateCW:!1,rotateCCW:!1,hold:!1,pause:!1,restart:!1}}attach(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp)}detach(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}consume(t){const n=this.state[t];return this.state[t]=!1,n}match(t,n){return n.includes(t.key)}}function x(e){var s;const t=e.target;if(!t)return!1;const n=(s=t.tagName)==null?void 0:s.toLowerCase();return!!(n==="input"||n==="textarea"||n==="select"||t.isContentEditable)}const R={I:"#5dd1ff",O:"#ffd95d",T:"#b85dff",S:"#5dff9e",Z:"#ff5d87",J:"#5d83ff",L:"#ffa35d"},P={I:[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],O:[[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]]],T:[[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],S:[[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,0,0,0],[0,1,1,0],[1,1,0,0],[0,0,0,0]],[[1,0,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],Z:[[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[1,0,0,0],[0,0,0,0]]],J:[[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[1,1,0,0],[0,0,0,0]]],L:[[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[1,0,0,0],[0,0,0,0]],[[1,1,0,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]]]};function L(e){return P[e.type][e.rotation]}function*W(){const e=["I","O","T","S","Z","J","L"];for(;;){const t=[...e];for(let n=t.length-1;n>0;n--){const s=Math.floor(Math.random()*(n+1));[t[n],t[s]]=[t[s],t[n]]}for(const n of t)yield n}}function J(e){const t=["I","O","T","S","Z","J","L"];function*n(){for(;;){const s=[...t];for(let r=s.length-1;r>0;r--){const i=Math.floor(e()*(r+1));[s[r],s[i]]=[s[i],s[r]]}for(const r of s)yield r}}return n()}function G(e){let t=e|0||1;return J(()=>(t^=t<<13,t^=t>>>17,t^=t<<5,(t>>>0)%4294967295/4294967295))}const m=10,v=22;function N(){return Array.from({length:v},()=>Array(m).fill(0))}function B(e){const t=typeof e=="number"?G(e):W(),n={field:N(),active:null,hold:null,holdLocked:!1,queue:[],bag:t,score:0,level:1,lines:0,gravityMs:1e3,gravityTimer:0,lockDelayMs:500,lockTimer:0,status:"playing"};return q(n),T(n),n}function q(e){for(;e.queue.length<5;)e.queue.push(e.bag.next().value)}function T(e){const t=e.queue.shift();q(e);const n={type:t,rotation:0,x:3,y:0};if(S(e,n)){e.status="gameover";return}e.active=n,e.holdLocked=!1}function X(e,t){let n=t.y;for(;!S(e,{...t,y:n+1});)n++;return n}function F(e,t,n){if(!e.active)return!1;const s={...e.active,x:e.active.x+t,y:e.active.y+n};return S(e,s)?!1:(e.active=s,!0)}function re(e,t){if(!e.active)return!1;const n=((e.active.rotation+t)%4+4)%4,s=Y(e.active.type,e.active.rotation,n);for(const[r,i]of s){const o={...e.active,rotation:n,x:e.active.x+r,y:e.active.y+i};if(!S(e,o))return e.active=o,!0}return!1}function Y(e,t,n){const s=[[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]]],r=[[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],[[0,0],[1,0],[-2,0],[1,-2],[-2,1]]];if(e==="O")return[[0,0]];const i=e==="I"?r:s,o=t===0&&n===1||t===1&&n===2||t===2&&n===3||t===3&&n===0?t%4:(t+3)%4;return i[o]}function S(e,t){const n=L(t);for(let s=0;s<4;s++)for(let r=0;r<4;r++){if(!n[s][r])continue;const i=t.x+r,o=t.y+s;if(i<0||i>=m||o>=v||o>=0&&e.field[o][i])return!0}return!1}function ie(e,t){if(e.status!=="playing")return;e.gravityTimer+=t;let n=!1;for(;e.gravityTimer>=e.gravityMs;)e.gravityTimer-=e.gravityMs,n=F(e,0,1)||n;n?e.lockTimer=0:e.active&&S(e,{...e.active,y:e.active.y+1})?(e.lockTimer+=t,e.lockTimer>=e.lockDelayMs&&(D(e),H(e),$(e),T(e),e.lockTimer=0)):e.lockTimer=0}function oe(e){if(!e.active||e.holdLocked)return;const t=e.active.type;if(e.hold===null)e.hold=t,T(e);else{const n=e.hold;e.hold=t,e.active={type:n,rotation:0,x:3,y:0},S(e,e.active)&&(e.status="gameover")}e.holdLocked=!0}function ae(e){e.active&&(e.active.y=X(e,e.active),D(e),H(e),$(e),T(e),e.lockTimer=0)}function D(e){if(!e.active)return;const t=L(e.active);let n=0;for(let s=0;s<4;s++)for(let r=0;r<4;r++){if(!t[s][r])continue;const i=e.active.x+r,o=e.active.y+s;o>=0&&o<v&&i>=0&&i<m&&(e.field[o][i]=e.active.type,o>=2&&n++)}n>0&&(e.score+=1),e.active=null}function H(e){let t=0;for(let n=v-1;n>=0;n--)e.field[n].every(s=>s!==0)&&(e.field.splice(n,1),e.field.unshift(Array(m).fill(0)),t++,n++);t>0&&(e.lines+=t,e.score+=Z(t,e.level))}function Z(e,t){return([0,100,300,500,800][e]??0)*t}function $(e){e.level=Math.floor(e.lines/10)+1,e.gravityMs=Math.max(60,1e3-(e.level-1)*80)}function ce(e){const t=B();Object.assign(e,t)}function le(e,t){if(!(t<=0)){for(let n=0;n<t;n++){const s=Math.floor(Math.random()*m);e.field.shift();const r=Array.from({length:m},(i,o)=>o===s?0:"Z");e.field.push(r)}for(let n=0;n<2;n++)for(let s=0;s<m;s++)if(e.field[n][s]!==0){e.status="gameover";return}}}const d=32;function fe(e,t){j(e,t.board),z(e,t.next),Q(e,t.hold),t.scoreEl.textContent=String(e.score),t.levelEl.textContent=String(e.level),t.linesEl.textContent=String(e.lines)}function j(e,t){const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height),n.fillStyle="#111433";for(let s=0;s<v-2;s++)for(let r=0;r<m;r++)n.fillRect(r*d+1,s*d+1,d-2,d-2);for(let s=2;s<v;s++)for(let r=0;r<m;r++){const i=e.field[s][r];i&&I(n,r,s-2,R[i])}if(e.active){const s=L(e.active);for(let r=0;r<4;r++)for(let i=0;i<4;i++){if(!s[r][i])continue;const o=e.active.x+i,l=e.active.y+r-2;l>=0&&I(n,o,l,R[e.active.type])}}}function I(e,t,n,s){const i=t*d,o=n*d;e.fillStyle=s,_(e,i+1,o+1,d-2,d-2,8),e.fill();const l=e.createLinearGradient(i,o,i,o+d);l.addColorStop(0,"rgba(255,255,255,0.25)"),l.addColorStop(1,"rgba(0,0,0,0.25)"),e.fillStyle=l,_(e,i+1,o+1,d-2,d-2,8),e.fill()}function _(e,t,n,s,r,i){e.beginPath(),e.moveTo(t+i,n),e.arcTo(t+s,n,t+s,n+r,i),e.arcTo(t+s,n+r,t,n+r,i),e.arcTo(t,n+r,t,n,i),e.arcTo(t,n,t+s,n,i),e.closePath()}function z(e,t){const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=e.queue.slice(0,3),r=12,i=Math.floor((t.height-r*2)/s.length),l=Math.max(12,Math.floor(i/4*.95)),a=4*l,c=Math.floor((t.width-a)/2);s.forEach((f,y)=>{const p=r+y*i+Math.floor((i-a)/2);E(n,f,c,p,l)})}function Q(e,t){const n=t.getContext("2d");if(n.clearRect(0,0,t.width,t.height),!e.hold)return;const s=18,r=4*s,i=Math.floor((t.width-r)/2),o=Math.floor((t.height-r)/2);E(n,e.hold,i,o,s)}function E(e,t,n,s,r){const i=R[t],o={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],O:[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],T:[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],S:[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],Z:[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],J:[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],L:[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]]};let l=4,a=4,c=-1,f=-1;for(let u=0;u<4;u++)for(let h=0;h<4;h++)o[t][u][h]&&(h<l&&(l=h),u<a&&(a=u),h>c&&(c=h),u>f&&(f=u));const y=c-l+1,g=f-a+1,p=Math.floor((4-y)/2)*r-l*r,b=Math.floor((4-g)/2)*r-a*r;for(let u=0;u<4;u++)for(let h=0;h<4;h++)o[t][u][h]&&(e.fillStyle=i,e.fillRect(n+p+h*r+1,s+b+u*r+1,r-2,r-2))}const O="tetris_highscores",w=window.__TETRIS_API__;function k(){const t=window.__SUPABASE__;if(!(!t||!t.url||!t.anonKey))return t}const M=10;function C(){try{const e=k();if(e!=null&&e.url&&(e!=null&&e.anonKey)){const s=new URL(`${e.url.replace(/\/$/,"")}/rest/v1/scores`);s.searchParams.set("select","name,score,level,lines,created_at"),s.searchParams.set("order","score.desc,created_at.desc"),s.searchParams.set("limit","10");const r=new XMLHttpRequest;if(r.open("GET",s.toString(),!1),r.setRequestHeader("apikey",e.anonKey),r.setRequestHeader("Authorization",`Bearer ${e.anonKey}`),r.send(),r.status>=200&&r.status<300)return JSON.parse(r.responseText).map(l=>({name:l.name,score:l.score,level:l.level,lines:l.lines,date:l.created_at??new Date().toISOString()}))}if(w){const s=new XMLHttpRequest;if(s.open("GET",`${w}/scores?limit=10`,!1),s.send(),s.status>=200&&s.status<300)return JSON.parse(s.responseText).map(o=>({name:o.name,score:o.score,level:o.level,lines:o.lines,date:o.createdAt??o.created_at??new Date().toISOString()}))}const t=localStorage.getItem(O);if(!t)return[];const n=JSON.parse(t);return Array.isArray(n)?n.filter(K).slice(0,M):[]}catch{return[]}}function V(e){const t=e.filter(K).sort((n,s)=>s.score-n.score||s.date.localeCompare(n.date)).slice(0,M);localStorage.setItem(O,JSON.stringify(t))}function ue(e,t=C()){var s;if(t.length<M)return!0;const n=((s=t[t.length-1])==null?void 0:s.score)??0;return e>n}function he(e,t,n){const s=new Date().toISOString(),r={name:e.trim()||"Anonymous",score:t,level:n==null?void 0:n.level,lines:n==null?void 0:n.lines,date:s};try{const a=k();if(a!=null&&a.url&&(a!=null&&a.anonKey)){const c=new XMLHttpRequest;if(c.open("POST",`${a.url.replace(/\/$/,"")}/rest/v1/scores`,!1),c.setRequestHeader("Content-Type","application/json"),c.setRequestHeader("apikey",a.anonKey),c.setRequestHeader("Authorization",`Bearer ${a.anonKey}`),c.setRequestHeader("Prefer","return=representation"),c.send(JSON.stringify({name:r.name,score:r.score,level:r.level??1,lines:r.lines??0})),c.status>=200&&c.status<300){const[f]=JSON.parse(c.responseText);f!=null&&f.created_at&&(r.date=f.created_at),typeof(f==null?void 0:f.level)=="number"&&(r.level=f.level),typeof(f==null?void 0:f.lines)=="number"&&(r.lines=f.lines)}}else if(w){const c=new XMLHttpRequest;c.open("POST",`${w}/scores`,!1),c.setRequestHeader("Content-Type","application/json"),c.send(JSON.stringify({name:r.name,score:r.score,level:r.level,lines:r.lines}))}}catch{}const i=C();i.push(r),i.sort((a,c)=>c.score-a.score||c.date.localeCompare(a.date));const o=i.slice(0,M);return V(o),{rank:o.findIndex(a=>a===r)+1||o.findIndex(a=>a.score===t)+1||-1,entries:o}}function de(e,t=C()){e.innerHTML=U(t)}function K(e){return e&&typeof e.name=="string"&&typeof e.score=="number"&&typeof e.date=="string"}function U(e){if(e.length===0)return'<div class="scoreboard__empty">No high scores yet. Be the first!</div>';const t='<div class="scoreboard__header"><span class="rank">#</span><span class="name">Name</span><span class="score">Score</span><span class="level">Level</span><span class="lines">Lines</span><span class="date">Date</span></div>',n=e.map((s,r)=>{const i=r+1,o=te(s.date),l=typeof s.level=="number"?s.level:"-",a=typeof s.lines=="number"?s.lines:"-";return`<div class="scoreboard__row"><span class="rank">${i}</span><span class="name">${ee(s.name)}</span><span class="score">${s.score.toLocaleString()}</span><span class="level">${l}</span><span class="lines">${a}</span><span class="date">${o}</span></div>`}).join("");return`<div class="scoreboard__wrap"><div class="scoreboard__title">High Scores</div>${t}${n}</div>`}function ee(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function te(e){const t=new Date(e),n=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),i=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0");return`${n}-${s}-${r} ${i}:${o}`}function pe(e){var o,l;const t=k(),n=(e||"").trim();if(!n)return null;try{if(t!=null&&t.url&&(t!=null&&t.anonKey)){const a=new URL(`${t.url.replace(/\/$/,"")}/rest/v1/scores`);a.searchParams.set("select","score"),a.searchParams.set("name",`eq.${encodeURIComponent(n)}`),a.searchParams.set("order","score.desc"),a.searchParams.set("limit","1");const c=new XMLHttpRequest;if(c.open("GET",a.toString(),!1),c.setRequestHeader("apikey",t.anonKey),c.setRequestHeader("Authorization",`Bearer ${t.anonKey}`),c.send(),!(c.status>=200&&c.status<300))return null;const f=JSON.parse(c.responseText),y=(o=f==null?void 0:f[0])==null?void 0:o.score;if(typeof y!="number")return null;const g=new URL(`${t.url.replace(/\/$/,"")}/rest/v1/scores`);g.searchParams.set("select","score"),g.searchParams.set("score",`gt.${y}`),g.searchParams.set("limit","1");const p=new XMLHttpRequest;p.open("GET",g.toString(),!1),p.setRequestHeader("apikey",t.anonKey),p.setRequestHeader("Authorization",`Bearer ${t.anonKey}`),p.setRequestHeader("Prefer","count=exact"),p.send();const b=p.getResponseHeader("Content-Range");if(!b)return 1;const u=parseInt(b.split("/")[1]||"0",10);return isFinite(u)?u+1:1}}catch{}const s=C(),r=(l=s.filter(a=>a.name===n).sort((a,c)=>c.score-a.score)[0])==null?void 0:l.score;return typeof r!="number"?null:s.filter(a=>a.score>r).length+1}export{ne as G,se as I,R as P,fe as a,re as b,B as c,oe as d,he as e,de as f,pe as g,ae as h,le as i,L as j,C as l,F as m,ue as q,ce as r,ie as t};
