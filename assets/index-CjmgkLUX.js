(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();class Q{constructor(t,n=1e3/60){this.accumulatorMs=0,this.lastTime=0,this.rafId=null,this.running=!1,this.callbacks=t,this.fixedStepMs=n}start(){if(this.running)return;this.running=!0,this.lastTime=performance.now();const t=()=>{if(!this.running)return;const n=performance.now();let r=n-this.lastTime;for(r>1e3&&(r=this.fixedStepMs),this.lastTime=n,this.accumulatorMs+=r;this.accumulatorMs>=this.fixedStepMs;)this.callbacks.update(this.fixedStepMs),this.accumulatorMs-=this.fixedStepMs;this.callbacks.render(),this.rafId=requestAnimationFrame(t)};this.rafId=requestAnimationFrame(t)}stop(){this.running=!1,this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=null}}const j={left:["ArrowLeft"],right:["ArrowRight"],softDrop:["ArrowDown"],hardDrop:[" "],rotateCW:["x","X","ArrowUp"],rotateCCW:["z","Z"],hold:["c","C"],pause:["p","P"],restart:["r","R"]};class V{constructor(t={}){this.onKeyDown=n=>{let r=!1;this.match(n,this.bindings.left)&&(this.state.left=!0,r=!0),this.match(n,this.bindings.right)&&(this.state.right=!0,r=!0),this.match(n,this.bindings.softDrop)&&(this.state.softDrop=!0,r=!0),this.match(n,this.bindings.hardDrop)&&(this.state.hardDrop=!0,r=!0),this.match(n,this.bindings.rotateCW)&&(this.state.rotateCW=!0,r=!0),this.match(n,this.bindings.rotateCCW)&&(this.state.rotateCCW=!0,r=!0),this.match(n,this.bindings.hold)&&(this.state.hold=!0,r=!0),this.match(n,this.bindings.pause)&&(this.state.pause=!0,r=!0),this.match(n,this.bindings.restart)&&(this.state.restart=!0,r=!0),r&&!D(n)&&n.preventDefault()},this.onKeyUp=n=>{let r=!1;this.match(n,this.bindings.left)&&(this.state.left=!1,r=!0),this.match(n,this.bindings.right)&&(this.state.right=!1,r=!0),this.match(n,this.bindings.softDrop)&&(this.state.softDrop=!1,r=!0),this.match(n,this.bindings.hardDrop)&&(this.state.hardDrop=!1,r=!0),this.match(n,this.bindings.rotateCW)&&(this.state.rotateCW=!1,r=!0),this.match(n,this.bindings.rotateCCW)&&(this.state.rotateCCW=!1,r=!0),this.match(n,this.bindings.hold)&&(this.state.hold=!1,r=!0),this.match(n,this.bindings.pause)&&(this.state.pause=!1,r=!0),this.match(n,this.bindings.restart)&&(this.state.restart=!1,r=!0),r&&!D(n)&&n.preventDefault()},this.bindings={...j,...t},this.state={left:!1,right:!1,softDrop:!1,hardDrop:!1,rotateCW:!1,rotateCCW:!1,hold:!1,pause:!1,restart:!1}}attach(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp)}detach(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}consume(t){const n=this.state[t];return this.state[t]=!1,n}match(t,n){return n.includes(t.key)}}function D(e){var r;const t=e.target;if(!t)return!1;const n=(r=t.tagName)==null?void 0:r.toLowerCase();return!!(n==="input"||n==="textarea"||n==="select"||t.isContentEditable)}const L={I:"#5dd1ff",O:"#ffd95d",T:"#b85dff",S:"#5dff9e",Z:"#ff5d87",J:"#5d83ff",L:"#ffa35d"},U={I:[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],O:[[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]]],T:[[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],S:[[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,0,0,0],[0,1,1,0],[1,1,0,0],[0,0,0,0]],[[1,0,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],Z:[[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[1,0,0,0],[0,0,0,0]]],J:[[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[1,1,0,0],[0,0,0,0]]],L:[[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[1,0,0,0],[0,0,0,0]],[[1,1,0,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]]]};function M(e){return U[e.type][e.rotation]}function*ee(){const e=["I","O","T","S","Z","J","L"];for(;;){const t=[...e];for(let n=t.length-1;n>0;n--){const r=Math.floor(Math.random()*(n+1));[t[n],t[r]]=[t[r],t[n]]}for(const n of t)yield n}}const g=10,y=22;function te(){return Array.from({length:y},()=>Array(g).fill(0))}function H(){const e=ee(),t={field:te(),active:null,hold:null,holdLocked:!1,queue:[],bag:e,score:0,level:1,lines:0,gravityMs:1e3,gravityTimer:0,lockDelayMs:500,lockTimer:0,status:"playing"};return q(t),C(t),t}function q(e){for(;e.queue.length<5;)e.queue.push(e.bag.next().value)}function C(e){const t=e.queue.shift();q(e);const n={type:t,rotation:0,x:3,y:0};if(S(e,n)){e.status="gameover";return}e.active=n,e.holdLocked=!1}function ne(e,t){let n=t.y;for(;!S(e,{...t,y:n+1});)n++;return n}function I(e,t,n){if(!e.active)return!1;const r={...e.active,x:e.active.x+t,y:e.active.y+n};return S(e,r)?!1:(e.active=r,!0)}function O(e,t){if(!e.active)return!1;const n=((e.active.rotation+t)%4+4)%4,r=re(e.active.type,e.active.rotation,n);for(const[i,o]of r){const s={...e.active,rotation:n,x:e.active.x+i,y:e.active.y+o};if(!S(e,s))return e.active=s,!0}return!1}function re(e,t,n){const r=[[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]]],i=[[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],[[0,0],[1,0],[-2,0],[1,-2],[-2,1]]];if(e==="O")return[[0,0]];const o=e==="I"?i:r,s=t===0&&n===1||t===1&&n===2||t===2&&n===3||t===3&&n===0?t%4:(t+3)%4;return o[s]}function S(e,t){const n=M(t);for(let r=0;r<4;r++)for(let i=0;i<4;i++){if(!n[r][i])continue;const o=t.x+i,s=t.y+r;if(o<0||o>=g||s>=y||s>=0&&e.field[s][o])return!0}return!1}function ie(e,t){if(e.status!=="playing")return;e.gravityTimer+=t;let n=!1;for(;e.gravityTimer>=e.gravityMs;)e.gravityTimer-=e.gravityMs,n=I(e,0,1)||n;n?e.lockTimer=0:e.active&&S(e,{...e.active,y:e.active.y+1})?(e.lockTimer+=t,e.lockTimer>=e.lockDelayMs&&(B(e),P(e),K(e),C(e),e.lockTimer=0)):e.lockTimer=0}function oe(e){if(!e.active||e.holdLocked)return;const t=e.active.type;if(e.hold===null)e.hold=t,C(e);else{const n=e.hold;e.hold=t,e.active={type:n,rotation:0,x:3,y:0},S(e,e.active)&&(e.status="gameover")}e.holdLocked=!0}function se(e){e.active&&(e.active.y=ne(e,e.active),B(e),P(e),K(e),C(e),e.lockTimer=0)}function B(e){if(!e.active)return;const t=M(e.active);let n=0;for(let r=0;r<4;r++)for(let i=0;i<4;i++){if(!t[r][i])continue;const o=e.active.x+i,s=e.active.y+r;s>=0&&s<y&&o>=0&&o<g&&(e.field[s][o]=e.active.type,s>=2&&n++)}n>0&&(e.score+=1),e.active=null}function P(e){let t=0;for(let n=y-1;n>=0;n--)e.field[n].every(r=>r!==0)&&(e.field.splice(n,1),e.field.unshift(Array(g).fill(0)),t++,n++);t>0&&(e.lines+=t,e.score+=ae(t,e.level))}function ae(e,t){return([0,100,300,500,800][e]??0)*t}function K(e){e.level=Math.floor(e.lines/10)+1,e.gravityMs=Math.max(60,1e3-(e.level-1)*80)}function N(e){const t=H();Object.assign(e,t)}const d=32;function ce(e,t){le(e,t.board),fe(e,t.next),ue(e,t.hold),t.scoreEl.textContent=String(e.score),t.levelEl.textContent=String(e.level),t.linesEl.textContent=String(e.lines)}function le(e,t){const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height),n.fillStyle="#111433";for(let r=0;r<y-2;r++)for(let i=0;i<g;i++)n.fillRect(i*d+1,r*d+1,d-2,d-2);for(let r=2;r<y;r++)for(let i=0;i<g;i++){const o=e.field[r][i];o&&k(n,i,r-2,L[o])}if(e.active){const r=M(e.active);for(let i=0;i<4;i++)for(let o=0;o<4;o++){if(!r[i][o])continue;const s=e.active.x+o,a=e.active.y+i-2;a>=0&&k(n,s,a,L[e.active.type])}}}function k(e,t,n,r){const o=t*d,s=n*d;e.fillStyle=r,R(e,o+1,s+1,d-2,d-2,8),e.fill();const a=e.createLinearGradient(o,s,o,s+d);a.addColorStop(0,"rgba(255,255,255,0.25)"),a.addColorStop(1,"rgba(0,0,0,0.25)"),e.fillStyle=a,R(e,o+1,s+1,d-2,d-2,8),e.fill()}function R(e,t,n,r,i,o){e.beginPath(),e.moveTo(t+o,n),e.arcTo(t+r,n,t+r,n+i,o),e.arcTo(t+r,n+i,t,n+i,o),e.arcTo(t,n+i,t,n,o),e.arcTo(t,n,t+r,n,o),e.closePath()}function fe(e,t){const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const r=e.queue.slice(0,3),i=10,o=Math.floor((t.height-i*2)/r.length),s=Math.max(12,Math.floor(o/4)),a=4*s,c=Math.floor((t.width-a)/2);r.forEach((h,b)=>{const E=i+b*o+Math.floor((o-a)/2);J(n,h,c,E,s)})}function ue(e,t){const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height),e.hold&&J(n,e.hold,10,10,20)}function J(e,t,n,r,i){const o=L[t],s={I:[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]],O:[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],T:[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],S:[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],Z:[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],J:[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],L:[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]]};let a=4,c=4,h=-1,b=-1;for(let f=0;f<4;f++)for(let u=0;u<4;u++)s[t][f][u]&&(u<a&&(a=u),f<c&&(c=f),u>h&&(h=u),f>b&&(b=f));const _=h-a+1,E=b-c+1,z=Math.floor((4-_)/2)*i-a*i,F=Math.floor((4-E)/2)*i-c*i;for(let f=0;f<4;f++)for(let u=0;u<4;u++)s[t][f][u]&&(e.fillStyle=o,e.fillRect(n+z+u*i+1,r+F+f*i+1,i-2,i-2))}const W="tetris_highscores",w=window.__TETRIS_API__;function X(){const t=window.__SUPABASE__;if(!(!t||!t.url||!t.anonKey))return t}const T=10;function v(){try{const e=X();if(e!=null&&e.url&&(e!=null&&e.anonKey)){const r=new URL(`${e.url.replace(/\/$/,"")}/rest/v1/scores`);r.searchParams.set("select","name,score,created_at"),r.searchParams.set("order","score.desc,created_at.desc"),r.searchParams.set("limit","10");const i=new XMLHttpRequest;if(i.open("GET",r.toString(),!1),i.setRequestHeader("apikey",e.anonKey),i.setRequestHeader("Authorization",`Bearer ${e.anonKey}`),i.send(),i.status>=200&&i.status<300)return JSON.parse(i.responseText).map(a=>({name:a.name,score:a.score,date:a.created_at??new Date().toISOString()}))}if(w){const r=new XMLHttpRequest;if(r.open("GET",`${w}/scores?limit=10`,!1),r.send(),r.status>=200&&r.status<300)return JSON.parse(r.responseText).map(s=>({name:s.name,score:s.score,date:s.createdAt??s.created_at??new Date().toISOString()}))}const t=localStorage.getItem(W);if(!t)return[];const n=JSON.parse(t);return Array.isArray(n)?n.filter(Y).slice(0,T):[]}catch{return[]}}function de(e){const t=e.filter(Y).sort((n,r)=>r.score-n.score||r.date.localeCompare(n.date)).slice(0,T);localStorage.setItem(W,JSON.stringify(t))}function he(e,t=v()){var r;if(t.length<T)return!0;const n=((r=t[t.length-1])==null?void 0:r.score)??0;return e>n}function pe(e,t){const n=new Date().toISOString(),r={name:e.trim()||"Anonymous",score:t,date:n};try{const a=X();if(a!=null&&a.url&&(a!=null&&a.anonKey)){const c=new XMLHttpRequest;if(c.open("POST",`${a.url.replace(/\/$/,"")}/rest/v1/scores`,!1),c.setRequestHeader("Content-Type","application/json"),c.setRequestHeader("apikey",a.anonKey),c.setRequestHeader("Authorization",`Bearer ${a.anonKey}`),c.setRequestHeader("Prefer","return=representation"),c.send(JSON.stringify({name:r.name,score:r.score})),c.status>=200&&c.status<300){const[h]=JSON.parse(c.responseText);h!=null&&h.created_at&&(r.date=h.created_at)}}else if(w){const c=new XMLHttpRequest;c.open("POST",`${w}/scores`,!1),c.setRequestHeader("Content-Type","application/json"),c.send(JSON.stringify({name:r.name,score:r.score}))}}catch{}const i=v();i.push(r),i.sort((a,c)=>c.score-a.score||c.date.localeCompare(a.date));const o=i.slice(0,T);return de(o),{rank:o.findIndex(a=>a===r)+1||o.findIndex(a=>a.score===t)+1||-1,entries:o}}function $(e,t=v()){e.innerHTML=me(t)}function Y(e){return e&&typeof e.name=="string"&&typeof e.score=="number"&&typeof e.date=="string"}function me(e){return e.length===0?'<div class="scoreboard__empty">No high scores yet. Be the first!</div>':`<div class="scoreboard__wrap"><div class="scoreboard__title">High Scores</div>${e.map((n,r)=>{const i=r+1,o=new Date(n.date).toLocaleDateString(void 0,{month:"short",day:"numeric"});return`<div class="scoreboard__row"><span class="rank">${i}</span><span class="name">${ge(n.name)}</span><span class="score">${n.score.toLocaleString()}</span><span class="date">${o}</span></div>`}).join("")}</div>`}function ge(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}const ye=document.getElementById("board"),ve=document.getElementById("next"),Se=document.getElementById("hold"),be=document.getElementById("score"),Ie=document.getElementById("level"),we=document.getElementById("lines"),x=document.getElementById("btn-pause"),Ce=document.getElementById("btn-restart"),G=document.getElementById("scoreboard"),Te={board:ye,next:ve,hold:Se,scoreEl:be,levelEl:Ie,linesEl:we},p=new V;p.attach();const l=H();let m=!1,A=l.status;x.addEventListener("click",()=>Z());Ce.addEventListener("click",()=>{N(l),m=!1,x.textContent="Pause"});function Z(){m=!m,x.textContent=m?"Resume":"Pause"}function xe(){if(p.consume("pause")&&Z(),p.consume("restart")&&(N(l),m=!1,x.textContent="Pause"),m||l.status!=="playing")return;const e=p.consume("left"),t=p.consume("right");e&&I(l,-1,0),t&&I(l,1,0),p.consume("softDrop")&&I(l,0,1),p.consume("rotateCW")&&O(l,1),p.consume("rotateCCW")&&O(l,-1),p.consume("hardDrop")&&se(l),p.consume("hold")&&oe(l)}const Ee=new Q({update:e=>{xe(),m||ie(l,e),A!==l.status&&(l.status==="gameover"&&_e(),A=l.status)},render:()=>ce(l,Te)});Ee.start();const Le="https://chbibdnqynilfuczbygg.supabase.co",Me="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoYmliZG5xeW5pbGZ1Y3pieWdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MDc0OTQsImV4cCI6MjA3MDI4MzQ5NH0.VuwTKXiU1Yx4C_fQCIp5X20m8SupxBkCKhQzN7Vqe20";window.__SUPABASE__={url:Le,anonKey:Me};$(G,v());function _e(){const e=l.score,t=v();if(he(e,t)){const n=localStorage.getItem("tetris_player_name")??"",r=prompt("New High Score! Enter your name:",n??""),i=r&&r.trim()?r.trim():n||"Anonymous";try{localStorage.setItem("tetris_player_name",i)}catch{}pe(i,e)}$(G,v())}
