import{c as Se,L as we}from"./lobby-DR5AaX3T.js";class Ee{constructor(t,n=1e3/60){this.accumulatorMs=0,this.lastTime=0,this.rafId=null,this.running=!1,this.callbacks=t,this.fixedStepMs=n}start(){if(this.running)return;this.running=!0,this.lastTime=performance.now();const t=()=>{if(!this.running)return;const n=performance.now();let s=n-this.lastTime;for(s>1e3&&(s=this.fixedStepMs),this.lastTime=n,this.accumulatorMs+=s;this.accumulatorMs>=this.fixedStepMs;)this.callbacks.update(this.fixedStepMs),this.accumulatorMs-=this.fixedStepMs;this.callbacks.render(),this.rafId=requestAnimationFrame(t)};this.rafId=requestAnimationFrame(t)}stop(){this.running=!1,this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=null}}const Ie={left:["ArrowLeft"],right:["ArrowRight"],softDrop:["ArrowDown"],hardDrop:[" "],rotateCW:["x","X","ArrowUp"],rotateCCW:["z","Z"],hold:["c","C"],pause:["p","P"],restart:["r","R"]};class Ce{constructor(t={}){this.onKeyDown=n=>{let s=!1;this.match(n,this.bindings.left)&&(this.state.left=!0,s=!0),this.match(n,this.bindings.right)&&(this.state.right=!0,s=!0),this.match(n,this.bindings.softDrop)&&(this.state.softDrop=!0,s=!0),this.match(n,this.bindings.hardDrop)&&(this.state.hardDrop=!0,s=!0),this.match(n,this.bindings.rotateCW)&&(this.state.rotateCW=!0,s=!0),this.match(n,this.bindings.rotateCCW)&&(this.state.rotateCCW=!0,s=!0),this.match(n,this.bindings.hold)&&(this.state.hold=!0,s=!0),this.match(n,this.bindings.pause)&&(this.state.pause=!0,s=!0),this.match(n,this.bindings.restart)&&(this.state.restart=!0,s=!0),s&&!V(n)&&n.preventDefault()},this.onKeyUp=n=>{let s=!1;this.match(n,this.bindings.left)&&(this.state.left=!1,s=!0),this.match(n,this.bindings.right)&&(this.state.right=!1,s=!0),this.match(n,this.bindings.softDrop)&&(this.state.softDrop=!1,s=!0),this.match(n,this.bindings.hardDrop)&&(this.state.hardDrop=!1,s=!0),this.match(n,this.bindings.rotateCW)&&(this.state.rotateCW=!1,s=!0),this.match(n,this.bindings.rotateCCW)&&(this.state.rotateCCW=!1,s=!0),this.match(n,this.bindings.hold)&&(this.state.hold=!1,s=!0),this.match(n,this.bindings.pause)&&(this.state.pause=!1,s=!0),this.match(n,this.bindings.restart)&&(this.state.restart=!1,s=!0),s&&!V(n)&&n.preventDefault()},this.bindings={...Ie,...t},this.state={left:!1,right:!1,softDrop:!1,hardDrop:!1,rotateCW:!1,rotateCCW:!1,hold:!1,pause:!1,restart:!1}}attach(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp)}detach(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}consume(t){const n=this.state[t];return this.state[t]=!1,n}match(t,n){return n.includes(t.key)}}function V(e){var s;const t=e.target;if(!t)return!1;const n=(s=t.tagName)==null?void 0:s.toLowerCase();return!!(n==="input"||n==="textarea"||n==="select"||t.isContentEditable)}const Y={I:"#5dd1ff",O:"#ffd95d",T:"#b85dff",S:"#5dff9e",Z:"#ff5d87",J:"#5d83ff",L:"#ffa35d"},xe={I:[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],O:[[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]]],T:[[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],S:[[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,0,0,0],[0,1,1,0],[1,1,0,0],[0,0,0,0]],[[1,0,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],Z:[[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[1,0,0,0],[0,0,0,0]]],J:[[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[1,1,0,0],[0,0,0,0]]],L:[[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[1,0,0,0],[0,0,0,0]],[[1,1,0,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]]]};function Z(e){return xe[e.type][e.rotation]}function*Le(){const e=["I","O","T","S","Z","J","L"];for(;;){const t=[...e];for(let n=t.length-1;n>0;n--){const s=Math.floor(Math.random()*(n+1));[t[n],t[s]]=[t[s],t[n]]}for(const n of t)yield n}}function ke(e){const t=["I","O","T","S","Z","J","L"];function*n(){for(;;){const s=[...t];for(let o=s.length-1;o>0;o--){const i=Math.floor(e()*(o+1));[s[o],s[i]]=[s[i],s[o]]}for(const o of s)yield o}}return n()}function Te(e){let t=e|0||1;return ke(()=>(t^=t<<13,t^=t>>>17,t^=t<<5,(t>>>0)%4294967295/4294967295))}const w=10,k=22;function Me(){return Array.from({length:k},()=>Array(w).fill(0))}function A(e){const t=typeof e=="number"?Te(e):Le(),n={field:Me(),active:null,hold:null,holdLocked:!1,queue:[],bag:t,score:0,level:1,lines:0,gravityMs:1e3,gravityTimer:0,lockDelayMs:500,lockTimer:0,status:"playing"};return ce(n),O(n),n}function ce(e){for(;e.queue.length<5;)e.queue.push(e.bag.next().value)}function O(e){const t=e.queue.shift();ce(e);const n={type:t,rotation:0,x:3,y:0};if(T(e,n)){e.status="gameover";return}e.active=n,e.holdLocked=!1}function _e(e,t){let n=t.y;for(;!T(e,{...t,y:n+1});)n++;return n}function D(e,t,n){if(!e.active)return!1;const s={...e.active,x:e.active.x+t,y:e.active.y+n};return T(e,s)?!1:(e.active=s,!0)}function ee(e,t){if(!e.active)return!1;const n=((e.active.rotation+t)%4+4)%4,s=Re(e.active.type,e.active.rotation,n);for(const[o,i]of s){const r={...e.active,rotation:n,x:e.active.x+o,y:e.active.y+i};if(!T(e,r))return e.active=r,!0}return!1}function Re(e,t,n){const s=[[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]]],o=[[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],[[0,0],[1,0],[-2,0],[1,-2],[-2,1]]];if(e==="O")return[[0,0]];const i=e==="I"?o:s,r=t===0&&n===1||t===1&&n===2||t===2&&n===3||t===3&&n===0?t%4:(t+3)%4;return i[r]}function T(e,t){const n=Z(t);for(let s=0;s<4;s++)for(let o=0;o<4;o++){if(!n[s][o])continue;const i=t.x+o,r=t.y+s;if(i<0||i>=w||r>=k||r>=0&&e.field[r][i])return!0}return!1}function Be(e,t){if(e.status!=="playing")return;e.gravityTimer+=t;let n=!1;for(;e.gravityTimer>=e.gravityMs;)e.gravityTimer-=e.gravityMs,n=D(e,0,1)||n;n?e.lockTimer=0:e.active&&T(e,{...e.active,y:e.active.y+1})?(e.lockTimer+=t,e.lockTimer>=e.lockDelayMs&&(le(e),de(e),ue(e),O(e),e.lockTimer=0)):e.lockTimer=0}function $e(e){if(!e.active||e.holdLocked)return;const t=e.active.type;if(e.hold===null)e.hold=t,O(e);else{const n=e.hold;e.hold=t,e.active={type:n,rotation:0,x:3,y:0},T(e,e.active)&&(e.status="gameover")}e.holdLocked=!0}function He(e){e.active&&(e.active.y=_e(e,e.active),le(e),de(e),ue(e),O(e),e.lockTimer=0)}function le(e){if(!e.active)return;const t=Z(e.active);let n=0;for(let s=0;s<4;s++)for(let o=0;o<4;o++){if(!t[s][o])continue;const i=e.active.x+o,r=e.active.y+s;r>=0&&r<k&&i>=0&&i<w&&(e.field[r][i]=e.active.type,r>=2&&n++)}n>0&&(e.score+=1),e.active=null}function de(e){let t=0;for(let n=k-1;n>=0;n--)e.field[n].every(s=>s!==0)&&(e.field.splice(n,1),e.field.unshift(Array(w).fill(0)),t++,n++);t>0&&(e.lines+=t,e.score+=De(t,e.level))}function De(e,t){return([0,100,300,500,800][e]??0)*t}function ue(e){e.level=Math.floor(e.lines/10)+1,e.gravityMs=Math.max(60,1e3-(e.level-1)*80)}function fe(e){const t=A();Object.assign(e,t)}function qe(e,t){if(!(t<=0)){for(let n=0;n<t;n++){const s=Math.floor(Math.random()*w);e.field.shift();const o=Array.from({length:w},(i,r)=>r===s?0:"Z");e.field.push(o)}for(let n=0;n<2;n++)for(let s=0;s<w;s++)if(e.field[n][s]!==0){e.status="gameover";return}}}const y=32;function Ae(e,t){Oe(e,t.board),Pe(e,t.next),Ke(e,t.hold),t.scoreEl.textContent=String(e.score),t.levelEl.textContent=String(e.level),t.linesEl.textContent=String(e.lines)}function Oe(e,t){const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height),n.fillStyle="#111433";for(let s=0;s<k-2;s++)for(let o=0;o<w;o++)n.fillRect(o*y+1,s*y+1,y-2,y-2);for(let s=2;s<k;s++)for(let o=0;o<w;o++){const i=e.field[s][o];i&&te(n,o,s-2,Y[i])}if(e.active){const s=Z(e.active);for(let o=0;o<4;o++)for(let i=0;i<4;i++){if(!s[o][i])continue;const r=e.active.x+i,d=e.active.y+o-2;d>=0&&te(n,r,d,Y[e.active.type])}}}function te(e,t,n,s){const i=t*y,r=n*y;e.fillStyle=s,ne(e,i+1,r+1,y-2,y-2,8),e.fill();const d=e.createLinearGradient(i,r,i,r+y);d.addColorStop(0,"rgba(255,255,255,0.25)"),d.addColorStop(1,"rgba(0,0,0,0.25)"),e.fillStyle=d,ne(e,i+1,r+1,y-2,y-2,8),e.fill()}function ne(e,t,n,s,o,i){e.beginPath(),e.moveTo(t+i,n),e.arcTo(t+s,n,t+s,n+o,i),e.arcTo(t+s,n+o,t,n+o,i),e.arcTo(t,n+o,t,n,i),e.arcTo(t,n,t+s,n,i),e.closePath()}function Pe(e,t){const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=e.queue.slice(0,3),o=12,i=Math.floor((t.height-o*2)/s.length),d=Math.max(12,Math.floor(i/4*.95)),a=4*d,l=Math.floor((t.width-a)/2);s.forEach((u,p)=>{const b=o+p*i+Math.floor((i-a)/2);he(n,u,l,b,d)})}function Ke(e,t){const n=t.getContext("2d");if(n.clearRect(0,0,t.width,t.height),!e.hold)return;const s=18,o=4*s,i=Math.floor((t.width-o)/2),r=Math.floor((t.height-o)/2);he(n,e.hold,i,r,s)}function he(e,t,n,s,o){const i=Y[t],r={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],O:[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],T:[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],S:[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],Z:[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],J:[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],L:[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]]};let d=4,a=4,l=-1,u=-1;for(let f=0;f<4;f++)for(let m=0;m<4;m++)r[t][f][m]&&(m<d&&(d=m),f<a&&(a=f),m>l&&(l=m),f>u&&(u=f));const p=l-d+1,v=u-a+1,b=Math.floor((4-p)/2)*o-d*o,B=Math.floor((4-v)/2)*o-a*o;for(let f=0;f<4;f++)for(let m=0;m<4;m++)r[t][f][m]&&(e.fillStyle=i,e.fillRect(n+b+m*o+1,s+B+f*o+1,o-2,o-2))}class Ne{constructor(t,n){this.channel=null,this.roomId=null,this.supa=Se(t,n,{realtime:{params:{eventsPerSecond:20}},auth:{persistSession:!1,autoRefreshToken:!1}}),this.userId=crypto.randomUUID()}join(t,n){this.roomId=t;const s=this.supa.channel(`room:${t}`,{config:{broadcast:{ack:!0}}});s.on("broadcast",{event:"message"},o=>{try{n(o.payload)}catch{}}),s.subscribe(o=>{o==="SUBSCRIBED"&&this.send({type:"join",payload:{userId:this.userId}})}),this.channel=s}leave(){this.channel&&(this.send({type:"leave",payload:{userId:this.userId}}),this.supa.removeChannel(this.channel),this.channel=null),this.roomId=null}send(t){this.channel&&this.channel.send({type:"broadcast",event:"message",payload:t})}}const me="tetris_highscores",q=window.__TETRIS_API__;function F(){const t=window.__SUPABASE__;if(!(!t||!t.url||!t.anonKey))return t}const P=10;function I(){try{const e=F();if(e!=null&&e.url&&(e!=null&&e.anonKey)){const s=new URL(`${e.url.replace(/\/$/,"")}/rest/v1/scores`);s.searchParams.set("select","name,score,level,lines,created_at"),s.searchParams.set("order","score.desc,created_at.desc"),s.searchParams.set("limit","10");const o=new XMLHttpRequest;if(o.open("GET",s.toString(),!1),o.setRequestHeader("apikey",e.anonKey),o.setRequestHeader("Authorization",`Bearer ${e.anonKey}`),o.send(),o.status>=200&&o.status<300)return JSON.parse(o.responseText).map(d=>({name:d.name,score:d.score,level:d.level,lines:d.lines,date:d.created_at??new Date().toISOString()}))}if(q){const s=new XMLHttpRequest;if(s.open("GET",`${q}/scores?limit=10`,!1),s.send(),s.status>=200&&s.status<300)return JSON.parse(s.responseText).map(r=>({name:r.name,score:r.score,level:r.level,lines:r.lines,date:r.createdAt??r.created_at??new Date().toISOString()}))}const t=localStorage.getItem(me);if(!t)return[];const n=JSON.parse(t);return Array.isArray(n)?n.filter(ye).slice(0,P):[]}catch{return[]}}function We(e){const t=e.filter(ye).sort((n,s)=>s.score-n.score||s.date.localeCompare(n.date)).slice(0,P);localStorage.setItem(me,JSON.stringify(t))}function Je(e,t=I()){var s;if(t.length<P)return!0;const n=((s=t[t.length-1])==null?void 0:s.score)??0;return e>n}function je(e,t,n){const s=new Date().toISOString(),o={name:e.trim()||"Anonymous",score:t,level:n==null?void 0:n.level,lines:n==null?void 0:n.lines,date:s};try{const a=F();if(a!=null&&a.url&&(a!=null&&a.anonKey)){const l=new XMLHttpRequest;if(l.open("POST",`${a.url.replace(/\/$/,"")}/rest/v1/scores`,!1),l.setRequestHeader("Content-Type","application/json"),l.setRequestHeader("apikey",a.anonKey),l.setRequestHeader("Authorization",`Bearer ${a.anonKey}`),l.setRequestHeader("Prefer","return=representation"),l.send(JSON.stringify({name:o.name,score:o.score,level:o.level??1,lines:o.lines??0})),l.status>=200&&l.status<300){const[u]=JSON.parse(l.responseText);u!=null&&u.created_at&&(o.date=u.created_at),typeof(u==null?void 0:u.level)=="number"&&(o.level=u.level),typeof(u==null?void 0:u.lines)=="number"&&(o.lines=u.lines)}}else if(q){const l=new XMLHttpRequest;l.open("POST",`${q}/scores`,!1),l.setRequestHeader("Content-Type","application/json"),l.send(JSON.stringify({name:o.name,score:o.score,level:o.level,lines:o.lines}))}}catch{}const i=I();i.push(o),i.sort((a,l)=>l.score-a.score||l.date.localeCompare(a.date));const r=i.slice(0,P);return We(r),{rank:r.findIndex(a=>a===o)+1||r.findIndex(a=>a.score===t)+1||-1,entries:r}}function pe(e,t=I()){e.innerHTML=Ge(t)}function ye(e){return e&&typeof e.name=="string"&&typeof e.score=="number"&&typeof e.date=="string"}function Ge(e){if(e.length===0)return'<div class="scoreboard__empty">No high scores yet. Be the first!</div>';const t='<div class="scoreboard__header"><span class="rank">#</span><span class="name">Name</span><span class="score">Score</span><span class="level">Level</span><span class="lines">Lines</span><span class="date">Date</span></div>',n=e.map((s,o)=>{const i=o+1,r=ze(s.date),d=typeof s.level=="number"?s.level:"-",a=typeof s.lines=="number"?s.lines:"-";return`<div class="scoreboard__row"><span class="rank">${i}</span><span class="name">${Xe(s.name)}</span><span class="score">${s.score.toLocaleString()}</span><span class="level">${d}</span><span class="lines">${a}</span><span class="date">${r}</span></div>`}).join("");return`<div class="scoreboard__wrap"><div class="scoreboard__title">High Scores</div>${t}${n}</div>`}function Xe(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function ze(e){const t=new Date(e),n=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),i=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0");return`${n}-${s}-${o} ${i}:${r}`}function Ye(e){var r,d;const t=F(),n=(e||"").trim();if(!n)return null;try{if(t!=null&&t.url&&(t!=null&&t.anonKey)){const a=new URL(`${t.url.replace(/\/$/,"")}/rest/v1/scores`);a.searchParams.set("select","score"),a.searchParams.set("name",`eq.${encodeURIComponent(n)}`),a.searchParams.set("order","score.desc"),a.searchParams.set("limit","1");const l=new XMLHttpRequest;if(l.open("GET",a.toString(),!1),l.setRequestHeader("apikey",t.anonKey),l.setRequestHeader("Authorization",`Bearer ${t.anonKey}`),l.send(),!(l.status>=200&&l.status<300))return null;const u=JSON.parse(l.responseText),p=(r=u==null?void 0:u[0])==null?void 0:r.score;if(typeof p!="number")return null;const v=new URL(`${t.url.replace(/\/$/,"")}/rest/v1/scores`);v.searchParams.set("select","score"),v.searchParams.set("score",`gt.${p}`),v.searchParams.set("limit","1");const b=new XMLHttpRequest;b.open("GET",v.toString(),!1),b.setRequestHeader("apikey",t.anonKey),b.setRequestHeader("Authorization",`Bearer ${t.anonKey}`),b.setRequestHeader("Prefer","count=exact"),b.send();const B=b.getResponseHeader("Content-Range");if(!B)return 1;const f=parseInt(B.split("/")[1]||"0",10);return isFinite(f)?f+1:1}}catch{}const s=I(),o=(d=s.filter(a=>a.name===n).sort((a,l)=>l.score-a.score)[0])==null?void 0:d.score;return typeof o!="number"?null:s.filter(a=>a.score>o).length+1}const ge=document.getElementById("board"),Ze=document.getElementById("next"),Fe=document.getElementById("hold"),Ue=document.getElementById("score"),Qe=document.getElementById("level"),Ve=document.getElementById("lines"),M=document.getElementById("btn-pause"),et=document.getElementById("btn-restart"),E=document.getElementById("scoreboard"),C=document.getElementById("opponent"),_=document.getElementById("room-id"),se=document.getElementById("room-label"),K=document.getElementById("btn-join"),N=document.getElementById("btn-leave"),$=document.getElementById("btn-ready"),W=document.getElementById("btn-start"),J=document.getElementById("btn-lobby"),j=document.getElementById("btn-create"),G=document.getElementById("btn-close-lobby"),R=document.getElementById("lobby"),oe=document.getElementById("room-list"),X=document.getElementById("nickname"),tt={board:ge,next:Ze,hold:Fe,scoreEl:Ue,levelEl:Qe,linesEl:Ve},S=new Ce;S.attach();const c=A();let g=!1,ie=c.status,h=null,x=null,re=0,H=!1,L=null;M.addEventListener("click",()=>U());et.addEventListener("click",()=>{fe(c),g=!1,M.textContent="Pause"});K==null||K.addEventListener("click",()=>{var s;const t=window.__SUPABASE__,n=(((s=_==null?void 0:_.value)==null?void 0:s.trim())||localStorage.getItem("tetris_room")||"").trim();!(t!=null&&t.url)||!(t!=null&&t.anonKey)||!n||(h&&h.leave(),h=new Ne(t.url,t.anonKey),h.join(n,o=>{if(o.type==="state"){const i=o.payload;x=i,i.attack&&i.attack>0&&qe(c,i.attack),ve()}else if(o.type==="start"){const i=performance.now(),r=Math.max(0,o.payload.at-i);setTimeout(()=>{Object.assign(c,A(o.payload.seed)),g=!1,M.textContent="Pause"},r)}}),se&&(se.textContent=`Room: ${n}`),localStorage.removeItem("tetris_room"))});N==null||N.addEventListener("click",()=>{h==null||h.leave(),x=null,ve()});$==null||$.addEventListener("click",()=>{H=!H,$.textContent=H?"Ready ✔":"Ready",h==null||h.send({type:"ready",payload:{userId:"me",ready:H}})});W==null||W.addEventListener("click",()=>{const e=Math.floor(Math.random()*2147483647),t=performance.now()+2e3;h==null||h.send({type:"start",payload:{seed:e,at:t}}),setTimeout(()=>{Object.assign(c,A(e)),g=!1,M.textContent="Pause"},2e3)});J==null||J.addEventListener("click",()=>{const t=window.__SUPABASE__;!(t!=null&&t.url)||!(t!=null&&t.anonKey)||!R||(R.style.display=R.style.display==="none"?"block":"none",L||(L=new we(t.url,t.anonKey),L.onUpdate=n=>nt(n),L.join((X==null?void 0:X.value)||"Anonymous")))});G==null||G.addEventListener("click",()=>{R&&(R.style.display="none")});j==null||j.addEventListener("click",()=>{if(!L)return;const e=L.createRoom("Room");_&&(_.value=e)});function nt(e){oe&&(oe.innerHTML=e.map(t=>`<div class="row" style="justify-content:space-between;"><span>${t.id} • ${t.host}</span><span>${t.players}/${t.max}</span></div>`).join(""))}function U(){g=!g,M.textContent=g?"Resume":"Pause"}function st(){if(S.consume("pause")&&U(),S.consume("restart")&&(fe(c),g=!1,M.textContent="Pause"),g||c.status!=="playing")return;const e=S.consume("left"),t=S.consume("right");e&&D(c,-1,0),t&&D(c,1,0),S.consume("softDrop")&&D(c,0,1),S.consume("rotateCW")&&ee(c,1),S.consume("rotateCCW")&&ee(c,-1),S.consume("hardDrop")&&He(c),S.consume("hold")&&$e(c)}const ot=new Ee({update:e=>{st(),g||Be(c,e),ct(),ie!==c.status&&(c.status==="gameover"&&at(),ie=c.status)},render:()=>Ae(c,tt)});ot.start();const it="https://chbibdnqynilfuczbygg.supabase.co",rt="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoYmliZG5xeW5pbGZ1Y3pieWdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MDc0OTQsImV4cCI6MjA3MDI4MzQ5NH0.VuwTKXiU1Yx4C_fQCIp5X20m8SupxBkCKhQzN7Vqe20";window.__SUPABASE__={url:it,anonKey:rt};E&&pe(E,I());Q();window.addEventListener("resize",Q);window.__tetris={getStatus:()=>c.status,isPaused:()=>g,pause:()=>{g||U()}};function at(){const e=c.score,t=I();if(Je(e,t)){const n=(localStorage.getItem("tetris_player_name")||"").trim(),s=(localStorage.getItem("tetris_nick")||"").trim();je(n||s||"Anonymous",e,{level:c.level,lines:c.lines})}E&&(pe(E,I()),Q());try{window.dispatchEvent(new CustomEvent("tetris:score-updated"))}catch{}}function Q(){if(!E)return;const e=16,t=window.innerHeight,n=ge.getBoundingClientRect(),s=Math.max(120,t-(n.bottom+e)-e);E.style.maxHeight=`${s}px`,E.style.overflowY="auto",document.body.style.paddingBottom=`${Math.ceil(E.getBoundingClientRect().height)+e}px`}let ae=0;function ct(){if(!h)return;const e=performance.now();if(e-ae<100||(ae=e,!c))return;const t=Math.max(0,c.lines-re);re=c.lines;const n=Math.floor(t/2),s={field:c.field.map(o=>o.map(i=>i?1:0)),active:c.active?{type:c.active.type,x:c.active.x,y:c.active.y,rotation:c.active.rotation}:null,score:c.score,level:c.level,lines:c.lines,status:c.status,attack:n>0?n:void 0};h.send({type:"state",payload:s})}function ve(){if(!C)return;const e=C.getContext("2d");if(e.clearRect(0,0,C.width,C.height),!x)return;const t=32,n=Math.floor((C.width-10*t)/2),s=Math.floor((C.height-20*t)/2);for(let o=2;o<x.field.length;o++)for(let i=0;i<x.field[0].length;i++)x.field[o][i]&&(e.fillStyle="#6ea8fe",e.fillRect(n+i*t+1,s+(o-2)*t+1,t-2,t-2))}const z=document.getElementById("btn-back");z==null||z.addEventListener("click",()=>{var n;const e=window.__tetris;if(e&&e.getStatus&&e.getStatus()==="playing"&&!((n=e.isPaused)!=null&&n.call(e))){const s=document.createElement("div");s.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:grid;place-items:center;z-index:2000;";const o=document.createElement("div");o.className="panel",o.style.cssText="width:min(420px,92vw);",o.innerHTML='<h2 style="margin:0 0 8px;">게임을 멈추고 나가시겠습니까?</h2><p class="muted" style="margin:0 0 12px;">진행 중인 게임은 일시정지됩니다.</p>';const i=document.createElement("div");i.className="row";const r=document.createElement("button");r.textContent="취소";const d=document.createElement("button");d.textContent="나가기",i.appendChild(r),i.appendChild(d),o.appendChild(i),s.appendChild(o),document.body.appendChild(s),r.addEventListener("click",()=>document.body.removeChild(s)),d.addEventListener("click",()=>{var a;try{(a=e.pause)==null||a.call(e)}catch{}location.href="../index.html"})}else location.href="../index.html"});(function(){const e=(localStorage.getItem("tetris_nick")||"").trim()||"Anonymous",t=document.getElementById("nick-badge");t&&(t.textContent=`닉네임: ${e}`)})();function be(){const e=document.getElementById("single-scoreboard");if(!e)return;e.innerHTML="";const n=I().sort((u,p)=>p.score-u.score||p.date.localeCompare(u.date)).slice(0,10),s=localStorage.getItem("tetris_player_name")||localStorage.getItem("tetris_nick")||"",o=Ye(s||""),i=document.createElement("div");i.className="single-sb-header";const r=document.createElement("div");r.className="single-sb-title",r.textContent="싱글 하이스코어 Top 10";const d=document.createElement("div");d.className="single-sb-rank",d.textContent=s?o?`내 순위: ${o}위`:"내 순위: 기록 없음":"내 순위: 닉네임이 설정되지 않았습니다",i.appendChild(r),i.appendChild(d),e.appendChild(i);const a=document.createElement("table");a.innerHTML='<thead><tr><th class="num">#</th><th>Name</th><th class="num">Score</th><th class="num">Level</th><th class="num">Lines</th><th class="num">Date</th></tr></thead>';const l=document.createElement("tbody");n.forEach((u,p)=>{const v=document.createElement("tr");v.innerHTML=`<td class="num">${p+1}</td><td>${u.name}</td><td class="num">${u.score.toLocaleString()}</td><td class="num">${typeof u.level=="number"?u.level:""}</td><td class="num">${typeof u.lines=="number"?u.lines:""}</td><td class="num">${new Date(u.date).toLocaleString()}</td>`,l.appendChild(v)}),a.appendChild(l),e.appendChild(a)}be();window.addEventListener("tetris:score-updated",be);
