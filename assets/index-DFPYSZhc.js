import{c as ve,L as be}from"./lobby-DR5AaX3T.js";class Ie{constructor(t,n=1e3/60){this.accumulatorMs=0,this.lastTime=0,this.rafId=null,this.running=!1,this.callbacks=t,this.fixedStepMs=n}start(){if(this.running)return;this.running=!0,this.lastTime=performance.now();const t=()=>{if(!this.running)return;const n=performance.now();let s=n-this.lastTime;for(s>1e3&&(s=this.fixedStepMs),this.lastTime=n,this.accumulatorMs+=s;this.accumulatorMs>=this.fixedStepMs;)this.callbacks.update(this.fixedStepMs),this.accumulatorMs-=this.fixedStepMs;this.callbacks.render(),this.rafId=requestAnimationFrame(t)};this.rafId=requestAnimationFrame(t)}stop(){this.running=!1,this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=null}}const Se={left:["ArrowLeft"],right:["ArrowRight"],softDrop:["ArrowDown"],hardDrop:[" "],rotateCW:["x","X","ArrowUp"],rotateCCW:["z","Z"],hold:["c","C"],pause:["p","P"],restart:["r","R"]};class we{constructor(t={}){this.onKeyDown=n=>{let s=!1;this.match(n,this.bindings.left)&&(this.state.left=!0,s=!0),this.match(n,this.bindings.right)&&(this.state.right=!0,s=!0),this.match(n,this.bindings.softDrop)&&(this.state.softDrop=!0,s=!0),this.match(n,this.bindings.hardDrop)&&(this.state.hardDrop=!0,s=!0),this.match(n,this.bindings.rotateCW)&&(this.state.rotateCW=!0,s=!0),this.match(n,this.bindings.rotateCCW)&&(this.state.rotateCCW=!0,s=!0),this.match(n,this.bindings.hold)&&(this.state.hold=!0,s=!0),this.match(n,this.bindings.pause)&&(this.state.pause=!0,s=!0),this.match(n,this.bindings.restart)&&(this.state.restart=!0,s=!0),s&&!Q(n)&&n.preventDefault()},this.onKeyUp=n=>{let s=!1;this.match(n,this.bindings.left)&&(this.state.left=!1,s=!0),this.match(n,this.bindings.right)&&(this.state.right=!1,s=!0),this.match(n,this.bindings.softDrop)&&(this.state.softDrop=!1,s=!0),this.match(n,this.bindings.hardDrop)&&(this.state.hardDrop=!1,s=!0),this.match(n,this.bindings.rotateCW)&&(this.state.rotateCW=!1,s=!0),this.match(n,this.bindings.rotateCCW)&&(this.state.rotateCCW=!1,s=!0),this.match(n,this.bindings.hold)&&(this.state.hold=!1,s=!0),this.match(n,this.bindings.pause)&&(this.state.pause=!1,s=!0),this.match(n,this.bindings.restart)&&(this.state.restart=!1,s=!0),s&&!Q(n)&&n.preventDefault()},this.bindings={...Se,...t},this.state={left:!1,right:!1,softDrop:!1,hardDrop:!1,rotateCW:!1,rotateCCW:!1,hold:!1,pause:!1,restart:!1}}attach(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp)}detach(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}consume(t){const n=this.state[t];return this.state[t]=!1,n}match(t,n){return n.includes(t.key)}}function Q(e){var s;const t=e.target;if(!t)return!1;const n=(s=t.tagName)==null?void 0:s.toLowerCase();return!!(n==="input"||n==="textarea"||n==="select"||t.isContentEditable)}const Y={I:"#5dd1ff",O:"#ffd95d",T:"#b85dff",S:"#5dff9e",Z:"#ff5d87",J:"#5d83ff",L:"#ffa35d"},Ee={I:[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],O:[[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]]],T:[[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],S:[[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,0,0,0],[0,1,1,0],[1,1,0,0],[0,0,0,0]],[[1,0,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],Z:[[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[1,0,0,0],[0,0,0,0]]],J:[[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[1,1,0,0],[0,0,0,0]]],L:[[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[1,0,0,0],[0,0,0,0]],[[1,1,0,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]]]};function z(e){return Ee[e.type][e.rotation]}function*Ce(){const e=["I","O","T","S","Z","J","L"];for(;;){const t=[...e];for(let n=t.length-1;n>0;n--){const s=Math.floor(Math.random()*(n+1));[t[n],t[s]]=[t[s],t[n]]}for(const n of t)yield n}}function xe(e){const t=["I","O","T","S","Z","J","L"];function*n(){for(;;){const s=[...t];for(let o=s.length-1;o>0;o--){const i=Math.floor(e()*(o+1));[s[o],s[i]]=[s[i],s[o]]}for(const o of s)yield o}}return n()}function Me(e){let t=e|0||1;return xe(()=>(t^=t<<13,t^=t>>>17,t^=t<<5,(t>>>0)%4294967295/4294967295))}const b=10,T=22;function Te(){return Array.from({length:T},()=>Array(b).fill(0))}function O(e){const t=typeof e=="number"?Me(e):Ce(),n={field:Te(),active:null,hold:null,holdLocked:!1,queue:[],bag:t,score:0,level:1,lines:0,gravityMs:1e3,gravityTimer:0,lockDelayMs:500,lockTimer:0,status:"playing"};return ae(n),A(n),n}function ae(e){for(;e.queue.length<5;)e.queue.push(e.bag.next().value)}function A(e){const t=e.queue.shift();ae(e);const n={type:t,rotation:0,x:3,y:0};if(k(e,n)){e.status="gameover";return}e.active=n,e.holdLocked=!1}function ke(e,t){let n=t.y;for(;!k(e,{...t,y:n+1});)n++;return n}function H(e,t,n){if(!e.active)return!1;const s={...e.active,x:e.active.x+t,y:e.active.y+n};return k(e,s)?!1:(e.active=s,!0)}function V(e,t){if(!e.active)return!1;const n=((e.active.rotation+t)%4+4)%4,s=Le(e.active.type,e.active.rotation,n);for(const[o,i]of s){const r={...e.active,rotation:n,x:e.active.x+o,y:e.active.y+i};if(!k(e,r))return e.active=r,!0}return!1}function Le(e,t,n){const s=[[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]]],o=[[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],[[0,0],[1,0],[-2,0],[1,-2],[-2,1]]];if(e==="O")return[[0,0]];const i=e==="I"?o:s,r=t===0&&n===1||t===1&&n===2||t===2&&n===3||t===3&&n===0?t%4:(t+3)%4;return i[r]}function k(e,t){const n=z(t);for(let s=0;s<4;s++)for(let o=0;o<4;o++){if(!n[s][o])continue;const i=t.x+o,r=t.y+s;if(i<0||i>=b||r>=T||r>=0&&e.field[r][i])return!0}return!1}function Re(e,t){if(e.status!=="playing")return;e.gravityTimer+=t;let n=!1;for(;e.gravityTimer>=e.gravityMs;)e.gravityTimer-=e.gravityMs,n=H(e,0,1)||n;n?e.lockTimer=0:e.active&&k(e,{...e.active,y:e.active.y+1})?(e.lockTimer+=t,e.lockTimer>=e.lockDelayMs&&(ce(e),le(e),ue(e),A(e),e.lockTimer=0)):e.lockTimer=0}function _e(e){if(!e.active||e.holdLocked)return;const t=e.active.type;if(e.hold===null)e.hold=t,A(e);else{const n=e.hold;e.hold=t,e.active={type:n,rotation:0,x:3,y:0},k(e,e.active)&&(e.status="gameover")}e.holdLocked=!0}function Be(e){e.active&&(e.active.y=ke(e,e.active),ce(e),le(e),ue(e),A(e),e.lockTimer=0)}function ce(e){if(!e.active)return;const t=z(e.active);let n=0;for(let s=0;s<4;s++)for(let o=0;o<4;o++){if(!t[s][o])continue;const i=e.active.x+o,r=e.active.y+s;r>=0&&r<T&&i>=0&&i<b&&(e.field[r][i]=e.active.type,r>=2&&n++)}n>0&&(e.score+=1),e.active=null}function le(e){let t=0;for(let n=T-1;n>=0;n--)e.field[n].every(s=>s!==0)&&(e.field.splice(n,1),e.field.unshift(Array(b).fill(0)),t++,n++);t>0&&(e.lines+=t,e.score+=De(t,e.level))}function De(e,t){return([0,100,300,500,800][e]??0)*t}function ue(e){e.level=Math.floor(e.lines/10)+1,e.gravityMs=Math.max(60,1e3-(e.level-1)*80)}function de(e){const t=O();Object.assign(e,t)}function $e(e,t){if(!(t<=0)){for(let n=0;n<t;n++){const s=Math.floor(Math.random()*b);e.field.shift();const o=Array.from({length:b},(i,r)=>r===s?0:"Z");e.field.push(o)}for(let n=0;n<2;n++)for(let s=0;s<b;s++)if(e.field[n][s]!==0){e.status="gameover";return}}}const m=32;function He(e,t){qe(e,t.board),Oe(e,t.next),Ae(e,t.hold),t.scoreEl.textContent=String(e.score),t.levelEl.textContent=String(e.level),t.linesEl.textContent=String(e.lines)}function qe(e,t){const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height),n.fillStyle="#111433";for(let s=0;s<T-2;s++)for(let o=0;o<b;o++)n.fillRect(o*m+1,s*m+1,m-2,m-2);for(let s=2;s<T;s++)for(let o=0;o<b;o++){const i=e.field[s][o];i&&ee(n,o,s-2,Y[i])}if(e.active){const s=z(e.active);for(let o=0;o<4;o++)for(let i=0;i<4;i++){if(!s[o][i])continue;const r=e.active.x+i,u=e.active.y+o-2;u>=0&&ee(n,r,u,Y[e.active.type])}}}function ee(e,t,n,s){const i=t*m,r=n*m;e.fillStyle=s,te(e,i+1,r+1,m-2,m-2,8),e.fill();const u=e.createLinearGradient(i,r,i,r+m);u.addColorStop(0,"rgba(255,255,255,0.25)"),u.addColorStop(1,"rgba(0,0,0,0.25)"),e.fillStyle=u,te(e,i+1,r+1,m-2,m-2,8),e.fill()}function te(e,t,n,s,o,i){e.beginPath(),e.moveTo(t+i,n),e.arcTo(t+s,n,t+s,n+o,i),e.arcTo(t+s,n+o,t,n+o,i),e.arcTo(t,n+o,t,n,i),e.arcTo(t,n,t+s,n,i),e.closePath()}function Oe(e,t){const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=e.queue.slice(0,3),o=12,i=Math.floor((t.height-o*2)/s.length),u=Math.max(12,Math.floor(i/4*.95)),a=4*u,l=Math.floor((t.width-a)/2);s.forEach((d,E)=>{const g=o+E*i+Math.floor((i-a)/2);fe(n,d,l,g,u)})}function Ae(e,t){const n=t.getContext("2d");if(n.clearRect(0,0,t.width,t.height),!e.hold)return;const s=18,o=4*s,i=Math.floor((t.width-o)/2),r=Math.floor((t.height-o)/2);fe(n,e.hold,i,r,s)}function fe(e,t,n,s,o){const i=Y[t],r={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],O:[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],T:[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],S:[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],Z:[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],J:[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],L:[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]]};let u=4,a=4,l=-1,d=-1;for(let f=0;f<4;f++)for(let p=0;p<4;p++)r[t][f][p]&&(p<u&&(u=p),f<a&&(a=f),p>l&&(l=p),f>d&&(d=f));const E=l-u+1,S=d-a+1,g=Math.floor((4-E)/2)*o-u*o,B=Math.floor((4-S)/2)*o-a*o;for(let f=0;f<4;f++)for(let p=0;p<4;p++)r[t][f][p]&&(e.fillStyle=i,e.fillRect(n+g+p*o+1,s+B+f*o+1,o-2,o-2))}class Ke{constructor(t,n){this.channel=null,this.roomId=null,this.supa=ve(t,n,{realtime:{params:{eventsPerSecond:20}},auth:{persistSession:!1,autoRefreshToken:!1}}),this.userId=crypto.randomUUID()}join(t,n){this.roomId=t;const s=this.supa.channel(`room:${t}`,{config:{broadcast:{ack:!0}}});s.on("broadcast",{event:"message"},o=>{try{n(o.payload)}catch{}}),s.subscribe(o=>{o==="SUBSCRIBED"&&this.send({type:"join",payload:{userId:this.userId}})}),this.channel=s}leave(){this.channel&&(this.send({type:"leave",payload:{userId:this.userId}}),this.supa.removeChannel(this.channel),this.channel=null),this.roomId=null}send(t){this.channel&&this.channel.send({type:"broadcast",event:"message",payload:t})}}const he="tetris_highscores",q=window.__TETRIS_API__;function Z(){const t=window.__SUPABASE__;if(!(!t||!t.url||!t.anonKey))return t}const K=10;function w(){try{const e=Z();if(e!=null&&e.url&&(e!=null&&e.anonKey)){const s=new URL(`${e.url.replace(/\/$/,"")}/rest/v1/scores`);s.searchParams.set("select","name,score,level,lines,created_at"),s.searchParams.set("order","score.desc,created_at.desc"),s.searchParams.set("limit","10");const o=new XMLHttpRequest;if(o.open("GET",s.toString(),!1),o.setRequestHeader("apikey",e.anonKey),o.setRequestHeader("Authorization",`Bearer ${e.anonKey}`),o.send(),o.status>=200&&o.status<300)return JSON.parse(o.responseText).map(u=>({name:u.name,score:u.score,level:u.level,lines:u.lines,date:u.created_at??new Date().toISOString()}))}if(q){const s=new XMLHttpRequest;if(s.open("GET",`${q}/scores?limit=10`,!1),s.send(),s.status>=200&&s.status<300)return JSON.parse(s.responseText).map(r=>({name:r.name,score:r.score,level:r.level,lines:r.lines,date:r.createdAt??r.created_at??new Date().toISOString()}))}const t=localStorage.getItem(he);if(!t)return[];const n=JSON.parse(t);return Array.isArray(n)?n.filter(me).slice(0,K):[]}catch{return[]}}function Pe(e){const t=e.filter(me).sort((n,s)=>s.score-n.score||s.date.localeCompare(n.date)).slice(0,K);localStorage.setItem(he,JSON.stringify(t))}function We(e,t=w()){var s;if(t.length<K)return!0;const n=((s=t[t.length-1])==null?void 0:s.score)??0;return e>n}function Je(e,t,n){const s=new Date().toISOString(),o={name:e.trim()||"Anonymous",score:t,level:n==null?void 0:n.level,lines:n==null?void 0:n.lines,date:s};try{const a=Z();if(a!=null&&a.url&&(a!=null&&a.anonKey)){const l=new XMLHttpRequest;if(l.open("POST",`${a.url.replace(/\/$/,"")}/rest/v1/scores`,!1),l.setRequestHeader("Content-Type","application/json"),l.setRequestHeader("apikey",a.anonKey),l.setRequestHeader("Authorization",`Bearer ${a.anonKey}`),l.setRequestHeader("Prefer","return=representation"),l.send(JSON.stringify({name:o.name,score:o.score,level:o.level??1,lines:o.lines??0})),l.status>=200&&l.status<300){const[d]=JSON.parse(l.responseText);d!=null&&d.created_at&&(o.date=d.created_at),typeof(d==null?void 0:d.level)=="number"&&(o.level=d.level),typeof(d==null?void 0:d.lines)=="number"&&(o.lines=d.lines)}}else if(q){const l=new XMLHttpRequest;l.open("POST",`${q}/scores`,!1),l.setRequestHeader("Content-Type","application/json"),l.send(JSON.stringify({name:o.name,score:o.score,level:o.level,lines:o.lines}))}}catch{}const i=w();i.push(o),i.sort((a,l)=>l.score-a.score||l.date.localeCompare(a.date));const r=i.slice(0,K);return Pe(r),{rank:r.findIndex(a=>a===o)+1||r.findIndex(a=>a.score===t)+1||-1,entries:r}}function pe(e,t=w()){e.innerHTML=je(t)}function me(e){return e&&typeof e.name=="string"&&typeof e.score=="number"&&typeof e.date=="string"}function je(e){if(e.length===0)return'<div class="scoreboard__empty">No high scores yet. Be the first!</div>';const t='<div class="scoreboard__header"><span class="rank">#</span><span class="name">Name</span><span class="score">Score</span><span class="level">Level</span><span class="lines">Lines</span><span class="date">Date</span></div>',n=e.map((s,o)=>{const i=o+1,r=Ge(s.date),u=typeof s.level=="number"?s.level:"-",a=typeof s.lines=="number"?s.lines:"-";return`<div class="scoreboard__row"><span class="rank">${i}</span><span class="name">${Ne(s.name)}</span><span class="score">${s.score.toLocaleString()}</span><span class="level">${u}</span><span class="lines">${a}</span><span class="date">${r}</span></div>`}).join("");return`<div class="scoreboard__wrap"><div class="scoreboard__title">High Scores</div>${t}${n}</div>`}function Ne(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Ge(e){const t=new Date(e),n=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),i=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0");return`${n}-${s}-${o} ${i}:${r}`}function at(e){var r,u;const t=Z(),n=(e||"").trim();if(!n)return null;try{if(t!=null&&t.url&&(t!=null&&t.anonKey)){const a=new URL(`${t.url.replace(/\/$/,"")}/rest/v1/scores`);a.searchParams.set("select","score"),a.searchParams.set("name",`eq.${encodeURIComponent(n)}`),a.searchParams.set("order","score.desc"),a.searchParams.set("limit","1");const l=new XMLHttpRequest;if(l.open("GET",a.toString(),!1),l.setRequestHeader("apikey",t.anonKey),l.setRequestHeader("Authorization",`Bearer ${t.anonKey}`),l.send(),!(l.status>=200&&l.status<300))return null;const d=JSON.parse(l.responseText),E=(r=d==null?void 0:d[0])==null?void 0:r.score;if(typeof E!="number")return null;const S=new URL(`${t.url.replace(/\/$/,"")}/rest/v1/scores`);S.searchParams.set("select","score"),S.searchParams.set("score",`gt.${E}`),S.searchParams.set("limit","1");const g=new XMLHttpRequest;g.open("GET",S.toString(),!1),g.setRequestHeader("apikey",t.anonKey),g.setRequestHeader("Authorization",`Bearer ${t.anonKey}`),g.setRequestHeader("Prefer","count=exact"),g.send();const B=g.getResponseHeader("Content-Range");if(!B)return 1;const f=parseInt(B.split("/")[1]||"0",10);return isFinite(f)?f+1:1}}catch{}const s=w(),o=(u=s.filter(a=>a.name===n).sort((a,l)=>l.score-a.score)[0])==null?void 0:u.score;return typeof o!="number"?null:s.filter(a=>a.score>o).length+1}const ye=document.getElementById("board"),Xe=document.getElementById("next"),Ye=document.getElementById("hold"),ze=document.getElementById("score"),Ze=document.getElementById("level"),Fe=document.getElementById("lines"),L=document.getElementById("btn-pause"),Ue=document.getElementById("btn-restart"),I=document.getElementById("scoreboard"),C=document.getElementById("opponent"),R=document.getElementById("room-id"),ne=document.getElementById("room-label"),P=document.getElementById("btn-join"),W=document.getElementById("btn-leave"),D=document.getElementById("btn-ready"),J=document.getElementById("btn-start"),j=document.getElementById("btn-lobby"),N=document.getElementById("btn-create"),G=document.getElementById("btn-close-lobby"),_=document.getElementById("lobby"),se=document.getElementById("room-list"),X=document.getElementById("nickname"),Qe={board:ye,next:Xe,hold:Ye,scoreEl:ze,levelEl:Ze,linesEl:Fe},v=new we;v.attach();const c=O();let y=!1,oe=c.status,h=null,x=null,ie=0,$=!1,M=null;L.addEventListener("click",()=>F());Ue.addEventListener("click",()=>{de(c),y=!1,L.textContent="Pause"});P==null||P.addEventListener("click",()=>{var s;const t=window.__SUPABASE__,n=(((s=R==null?void 0:R.value)==null?void 0:s.trim())||localStorage.getItem("tetris_room")||"").trim();!(t!=null&&t.url)||!(t!=null&&t.anonKey)||!n||(h&&h.leave(),h=new Ke(t.url,t.anonKey),h.join(n,o=>{if(o.type==="state"){const i=o.payload;x=i,i.attack&&i.attack>0&&$e(c,i.attack),ge()}else if(o.type==="start"){const i=performance.now(),r=Math.max(0,o.payload.at-i);setTimeout(()=>{Object.assign(c,O(o.payload.seed)),y=!1,L.textContent="Pause"},r)}}),ne&&(ne.textContent=`Room: ${n}`),localStorage.removeItem("tetris_room"))});W==null||W.addEventListener("click",()=>{h==null||h.leave(),x=null,ge()});D==null||D.addEventListener("click",()=>{$=!$,D.textContent=$?"Ready ✔":"Ready",h==null||h.send({type:"ready",payload:{userId:"me",ready:$}})});J==null||J.addEventListener("click",()=>{const e=Math.floor(Math.random()*2147483647),t=performance.now()+2e3;h==null||h.send({type:"start",payload:{seed:e,at:t}}),setTimeout(()=>{Object.assign(c,O(e)),y=!1,L.textContent="Pause"},2e3)});j==null||j.addEventListener("click",()=>{const t=window.__SUPABASE__;!(t!=null&&t.url)||!(t!=null&&t.anonKey)||!_||(_.style.display=_.style.display==="none"?"block":"none",M||(M=new be(t.url,t.anonKey),M.onUpdate=n=>Ve(n),M.join((X==null?void 0:X.value)||"Anonymous")))});G==null||G.addEventListener("click",()=>{_&&(_.style.display="none")});N==null||N.addEventListener("click",()=>{if(!M)return;const e=M.createRoom("Room");R&&(R.value=e)});function Ve(e){se&&(se.innerHTML=e.map(t=>`<div class="row" style="justify-content:space-between;"><span>${t.id} • ${t.host}</span><span>${t.players}/${t.max}</span></div>`).join(""))}function F(){y=!y,L.textContent=y?"Resume":"Pause"}function et(){if(v.consume("pause")&&F(),v.consume("restart")&&(de(c),y=!1,L.textContent="Pause"),y||c.status!=="playing")return;const e=v.consume("left"),t=v.consume("right");e&&H(c,-1,0),t&&H(c,1,0),v.consume("softDrop")&&H(c,0,1),v.consume("rotateCW")&&V(c,1),v.consume("rotateCCW")&&V(c,-1),v.consume("hardDrop")&&Be(c),v.consume("hold")&&_e(c)}const tt=new Ie({update:e=>{et(),y||Re(c,e),it(),oe!==c.status&&(c.status==="gameover"&&ot(),oe=c.status)},render:()=>He(c,Qe)});tt.start();const nt="https://chbibdnqynilfuczbygg.supabase.co",st="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoYmliZG5xeW5pbGZ1Y3pieWdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MDc0OTQsImV4cCI6MjA3MDI4MzQ5NH0.VuwTKXiU1Yx4C_fQCIp5X20m8SupxBkCKhQzN7Vqe20";window.__SUPABASE__={url:nt,anonKey:st};I&&pe(I,w());U();window.addEventListener("resize",U);window.__tetris={getStatus:()=>c.status,isPaused:()=>y,pause:()=>{y||F()}};function ot(){const e=c.score,t=w();if(We(e,t)){const n=(localStorage.getItem("tetris_player_name")||"").trim(),s=(localStorage.getItem("tetris_nick")||"").trim();Je(n||s||"Anonymous",e,{level:c.level,lines:c.lines})}I&&(pe(I,w()),U());try{window.dispatchEvent(new CustomEvent("tetris:score-updated"))}catch{}}function U(){if(!I)return;const e=16,t=window.innerHeight,n=ye.getBoundingClientRect(),s=Math.max(120,t-(n.bottom+e)-e);I.style.maxHeight=`${s}px`,I.style.overflowY="auto",document.body.style.paddingBottom=`${Math.ceil(I.getBoundingClientRect().height)+e}px`}let re=0;function it(){if(!h)return;const e=performance.now();if(e-re<100||(re=e,!c))return;const t=Math.max(0,c.lines-ie);ie=c.lines;const n=Math.floor(t/2),s={field:c.field.map(o=>o.map(i=>i?1:0)),active:c.active?{type:c.active.type,x:c.active.x,y:c.active.y,rotation:c.active.rotation}:null,score:c.score,level:c.level,lines:c.lines,status:c.status,attack:n>0?n:void 0};h.send({type:"state",payload:s})}function ge(){if(!C)return;const e=C.getContext("2d");if(e.clearRect(0,0,C.width,C.height),!x)return;const t=32,n=Math.floor((C.width-10*t)/2),s=Math.floor((C.height-20*t)/2);for(let o=2;o<x.field.length;o++)for(let i=0;i<x.field[0].length;i++)x.field[o][i]&&(e.fillStyle="#6ea8fe",e.fillRect(n+i*t+1,s+(o-2)*t+1,t-2,t-2))}export{at as c,w as l};
