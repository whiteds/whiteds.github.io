(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();class Q{constructor(t,n=1e3/60){this.accumulatorMs=0,this.lastTime=0,this.rafId=null,this.running=!1,this.callbacks=t,this.fixedStepMs=n}start(){if(this.running)return;this.running=!0,this.lastTime=performance.now();const t=()=>{if(!this.running)return;const n=performance.now();let s=n-this.lastTime;for(s>1e3&&(s=this.fixedStepMs),this.lastTime=n,this.accumulatorMs+=s;this.accumulatorMs>=this.fixedStepMs;)this.callbacks.update(this.fixedStepMs),this.accumulatorMs-=this.fixedStepMs;this.callbacks.render(),this.rafId=requestAnimationFrame(t)};this.rafId=requestAnimationFrame(t)}stop(){this.running=!1,this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=null}}const j={left:["ArrowLeft"],right:["ArrowRight"],softDrop:["ArrowDown"],hardDrop:[" "],rotateCW:["x","X","ArrowUp"],rotateCCW:["z","Z"],hold:["c","C"],pause:["p","P"],restart:["r","R"]};class V{constructor(t={}){this.onKeyDown=n=>{let s=!1;this.match(n,this.bindings.left)&&(this.state.left=!0,s=!0),this.match(n,this.bindings.right)&&(this.state.right=!0,s=!0),this.match(n,this.bindings.softDrop)&&(this.state.softDrop=!0,s=!0),this.match(n,this.bindings.hardDrop)&&(this.state.hardDrop=!0,s=!0),this.match(n,this.bindings.rotateCW)&&(this.state.rotateCW=!0,s=!0),this.match(n,this.bindings.rotateCCW)&&(this.state.rotateCCW=!0,s=!0),this.match(n,this.bindings.hold)&&(this.state.hold=!0,s=!0),this.match(n,this.bindings.pause)&&(this.state.pause=!0,s=!0),this.match(n,this.bindings.restart)&&(this.state.restart=!0,s=!0),s&&!O(n)&&n.preventDefault()},this.onKeyUp=n=>{let s=!1;this.match(n,this.bindings.left)&&(this.state.left=!1,s=!0),this.match(n,this.bindings.right)&&(this.state.right=!1,s=!0),this.match(n,this.bindings.softDrop)&&(this.state.softDrop=!1,s=!0),this.match(n,this.bindings.hardDrop)&&(this.state.hardDrop=!1,s=!0),this.match(n,this.bindings.rotateCW)&&(this.state.rotateCW=!1,s=!0),this.match(n,this.bindings.rotateCCW)&&(this.state.rotateCCW=!1,s=!0),this.match(n,this.bindings.hold)&&(this.state.hold=!1,s=!0),this.match(n,this.bindings.pause)&&(this.state.pause=!1,s=!0),this.match(n,this.bindings.restart)&&(this.state.restart=!1,s=!0),s&&!O(n)&&n.preventDefault()},this.bindings={...j,...t},this.state={left:!1,right:!1,softDrop:!1,hardDrop:!1,rotateCW:!1,rotateCCW:!1,hold:!1,pause:!1,restart:!1}}attach(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp)}detach(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}consume(t){const n=this.state[t];return this.state[t]=!1,n}match(t,n){return n.includes(t.key)}}function O(e){var s;const t=e.target;if(!t)return!1;const n=(s=t.tagName)==null?void 0:s.toLowerCase();return!!(n==="input"||n==="textarea"||n==="select"||t.isContentEditable)}const _={I:"#5dd1ff",O:"#ffd95d",T:"#b85dff",S:"#5dff9e",Z:"#ff5d87",J:"#5d83ff",L:"#ffa35d"},U={I:[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],O:[[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]]],T:[[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],S:[[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,0,0,0],[0,1,1,0],[1,1,0,0],[0,0,0,0]],[[1,0,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],Z:[[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[1,0,0,0],[0,0,0,0]]],J:[[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[1,1,0,0],[0,0,0,0]]],L:[[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[1,0,0,0],[0,0,0,0]],[[1,1,0,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]]]};function x(e){return U[e.type][e.rotation]}function*ee(){const e=["I","O","T","S","Z","J","L"];for(;;){const t=[...e];for(let n=t.length-1;n>0;n--){const s=Math.floor(Math.random()*(n+1));[t[n],t[s]]=[t[s],t[n]]}for(const n of t)yield n}}const y=10,v=22;function te(){return Array.from({length:v},()=>Array(y).fill(0))}function q(){const e=ee(),t={field:te(),active:null,hold:null,holdLocked:!1,queue:[],bag:e,score:0,level:1,lines:0,gravityMs:1e3,gravityTimer:0,lockDelayMs:500,lockTimer:0,status:"playing"};return $(t),C(t),t}function $(e){for(;e.queue.length<5;)e.queue.push(e.bag.next().value)}function C(e){const t=e.queue.shift();$(e);const n={type:t,rotation:0,x:3,y:0};if(b(e,n)){e.status="gameover";return}e.active=n,e.holdLocked=!1}function ne(e,t){let n=t.y;for(;!b(e,{...t,y:n+1});)n++;return n}function I(e,t,n){if(!e.active)return!1;const s={...e.active,x:e.active.x+t,y:e.active.y+n};return b(e,s)?!1:(e.active=s,!0)}function k(e,t){if(!e.active)return!1;const n=((e.active.rotation+t)%4+4)%4,s=se(e.active.type,e.active.rotation,n);for(const[i,r]of s){const o={...e.active,rotation:n,x:e.active.x+i,y:e.active.y+r};if(!b(e,o))return e.active=o,!0}return!1}function se(e,t,n){const s=[[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]]],i=[[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],[[0,0],[1,0],[-2,0],[1,-2],[-2,1]]];if(e==="O")return[[0,0]];const r=e==="I"?i:s,o=t===0&&n===1||t===1&&n===2||t===2&&n===3||t===3&&n===0?t%4:(t+3)%4;return r[o]}function b(e,t){const n=x(t);for(let s=0;s<4;s++)for(let i=0;i<4;i++){if(!n[s][i])continue;const r=t.x+i,o=t.y+s;if(r<0||r>=y||o>=v||o>=0&&e.field[o][r])return!0}return!1}function ie(e,t){if(e.status!=="playing")return;e.gravityTimer+=t;let n=!1;for(;e.gravityTimer>=e.gravityMs;)e.gravityTimer-=e.gravityMs,n=I(e,0,1)||n;n?e.lockTimer=0:e.active&&b(e,{...e.active,y:e.active.y+1})?(e.lockTimer+=t,e.lockTimer>=e.lockDelayMs&&(B(e),N(e),P(e),C(e),e.lockTimer=0)):e.lockTimer=0}function re(e){if(!e.active||e.holdLocked)return;const t=e.active.type;if(e.hold===null)e.hold=t,C(e);else{const n=e.hold;e.hold=t,e.active={type:n,rotation:0,x:3,y:0},b(e,e.active)&&(e.status="gameover")}e.holdLocked=!0}function oe(e){e.active&&(e.active.y=ne(e,e.active),B(e),N(e),P(e),C(e),e.lockTimer=0)}function B(e){if(!e.active)return;const t=x(e.active);let n=0;for(let s=0;s<4;s++)for(let i=0;i<4;i++){if(!t[s][i])continue;const r=e.active.x+i,o=e.active.y+s;o>=0&&o<v&&r>=0&&r<y&&(e.field[o][r]=e.active.type,o>=2&&n++)}n>0&&(e.score+=1),e.active=null}function N(e){let t=0;for(let n=v-1;n>=0;n--)e.field[n].every(s=>s!==0)&&(e.field.splice(n,1),e.field.unshift(Array(y).fill(0)),t++,n++);t>0&&(e.lines+=t,e.score+=ae(t,e.level))}function ae(e,t){return([0,100,300,500,800][e]??0)*t}function P(e){e.level=Math.floor(e.lines/10)+1,e.gravityMs=Math.max(60,1e3-(e.level-1)*80)}function K(e){const t=q();Object.assign(e,t)}const p=32;function ce(e,t){le(e,t.board),fe(e,t.next),ue(e,t.hold),t.scoreEl.textContent=String(e.score),t.levelEl.textContent=String(e.level),t.linesEl.textContent=String(e.lines)}function le(e,t){const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height),n.fillStyle="#111433";for(let s=0;s<v-2;s++)for(let i=0;i<y;i++)n.fillRect(i*p+1,s*p+1,p-2,p-2);for(let s=2;s<v;s++)for(let i=0;i<y;i++){const r=e.field[s][i];r&&R(n,i,s-2,_[r])}if(e.active){const s=x(e.active);for(let i=0;i<4;i++)for(let r=0;r<4;r++){if(!s[i][r])continue;const o=e.active.x+r,c=e.active.y+i-2;c>=0&&R(n,o,c,_[e.active.type])}}}function R(e,t,n,s){const r=t*p,o=n*p;e.fillStyle=s,A(e,r+1,o+1,p-2,p-2,8),e.fill();const c=e.createLinearGradient(r,o,r,o+p);c.addColorStop(0,"rgba(255,255,255,0.25)"),c.addColorStop(1,"rgba(0,0,0,0.25)"),e.fillStyle=c,A(e,r+1,o+1,p-2,p-2,8),e.fill()}function A(e,t,n,s,i,r){e.beginPath(),e.moveTo(t+r,n),e.arcTo(t+s,n,t+s,n+i,r),e.arcTo(t+s,n+i,t,n+i,r),e.arcTo(t,n+i,t,n,r),e.arcTo(t,n,t+s,n,r),e.closePath()}function fe(e,t){const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=e.queue.slice(0,3),i=12,r=Math.floor((t.height-i*2)/s.length),c=Math.max(12,Math.floor(r/4*.95)),a=4*c,l=Math.floor((t.width-a)/2);s.forEach((u,M)=>{const L=i+M*r+Math.floor((r-a)/2);J(n,u,l,L,c)})}function ue(e,t){const n=t.getContext("2d");if(n.clearRect(0,0,t.width,t.height),!e.hold)return;const s=18,i=4*s,r=Math.floor((t.width-i)/2),o=Math.floor((t.height-i)/2);J(n,e.hold,r,o,s)}function J(e,t,n,s,i){const r=_[t],o={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],O:[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],T:[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],S:[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],Z:[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],J:[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],L:[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]]};let c=4,a=4,l=-1,u=-1;for(let d=0;d<4;d++)for(let h=0;h<4;h++)o[t][d][h]&&(h<c&&(c=h),d<a&&(a=d),h>l&&(l=h),d>u&&(u=d));const M=l-c+1,D=u-a+1,L=Math.floor((4-M)/2)*i-c*i,z=Math.floor((4-D)/2)*i-a*i;for(let d=0;d<4;d++)for(let h=0;h<4;h++)o[t][d][h]&&(e.fillStyle=r,e.fillRect(n+L+h*i+1,s+z+d*i+1,i-2,i-2))}const W="tetris_highscores",w=window.__TETRIS_API__;function X(){const t=window.__SUPABASE__;if(!(!t||!t.url||!t.anonKey))return t}const T=10;function S(){try{const e=X();if(e!=null&&e.url&&(e!=null&&e.anonKey)){const s=new URL(`${e.url.replace(/\/$/,"")}/rest/v1/scores`);s.searchParams.set("select","name,score,level,lines,created_at"),s.searchParams.set("order","score.desc,created_at.desc"),s.searchParams.set("limit","10");const i=new XMLHttpRequest;if(i.open("GET",s.toString(),!1),i.setRequestHeader("apikey",e.anonKey),i.setRequestHeader("Authorization",`Bearer ${e.anonKey}`),i.send(),i.status>=200&&i.status<300)return JSON.parse(i.responseText).map(c=>({name:c.name,score:c.score,level:c.level,lines:c.lines,date:c.created_at??new Date().toISOString()}))}if(w){const s=new XMLHttpRequest;if(s.open("GET",`${w}/scores?limit=10`,!1),s.send(),s.status>=200&&s.status<300)return JSON.parse(s.responseText).map(o=>({name:o.name,score:o.score,level:o.level,lines:o.lines,date:o.createdAt??o.created_at??new Date().toISOString()}))}const t=localStorage.getItem(W);if(!t)return[];const n=JSON.parse(t);return Array.isArray(n)?n.filter(F).slice(0,T):[]}catch{return[]}}function de(e){const t=e.filter(F).sort((n,s)=>s.score-n.score||s.date.localeCompare(n.date)).slice(0,T);localStorage.setItem(W,JSON.stringify(t))}function he(e,t=S()){var s;if(t.length<T)return!0;const n=((s=t[t.length-1])==null?void 0:s.score)??0;return e>n}function pe(e,t,n){const s=new Date().toISOString(),i={name:e.trim()||"Anonymous",score:t,level:n==null?void 0:n.level,lines:n==null?void 0:n.lines,date:s};try{const a=X();if(a!=null&&a.url&&(a!=null&&a.anonKey)){const l=new XMLHttpRequest;if(l.open("POST",`${a.url.replace(/\/$/,"")}/rest/v1/scores`,!1),l.setRequestHeader("Content-Type","application/json"),l.setRequestHeader("apikey",a.anonKey),l.setRequestHeader("Authorization",`Bearer ${a.anonKey}`),l.setRequestHeader("Prefer","return=representation"),l.send(JSON.stringify({name:i.name,score:i.score,level:i.level??1,lines:i.lines??0})),l.status>=200&&l.status<300){const[u]=JSON.parse(l.responseText);u!=null&&u.created_at&&(i.date=u.created_at),typeof(u==null?void 0:u.level)=="number"&&(i.level=u.level),typeof(u==null?void 0:u.lines)=="number"&&(i.lines=u.lines)}}else if(w){const l=new XMLHttpRequest;l.open("POST",`${w}/scores`,!1),l.setRequestHeader("Content-Type","application/json"),l.send(JSON.stringify({name:i.name,score:i.score,level:i.level,lines:i.lines}))}}catch{}const r=S();r.push(i),r.sort((a,l)=>l.score-a.score||l.date.localeCompare(a.date));const o=r.slice(0,T);return de(o),{rank:o.findIndex(a=>a===i)+1||o.findIndex(a=>a.score===t)+1||-1,entries:o}}function Y(e,t=S()){e.innerHTML=me(t)}function F(e){return e&&typeof e.name=="string"&&typeof e.score=="number"&&typeof e.date=="string"}function me(e){if(e.length===0)return'<div class="scoreboard__empty">No high scores yet. Be the first!</div>';const t='<div class="scoreboard__header"><span class="rank">#</span><span class="name">Name</span><span class="score">Score</span><span class="level">Level</span><span class="lines">Lines</span><span class="date">Date</span></div>',n=e.map((s,i)=>{const r=i+1,o=ye(s.date),c=typeof s.level=="number"?s.level:"-",a=typeof s.lines=="number"?s.lines:"-";return`<div class="scoreboard__row"><span class="rank">${r}</span><span class="name">${ge(s.name)}</span><span class="score">${s.score.toLocaleString()}</span><span class="level">${c}</span><span class="lines">${a}</span><span class="date">${o}</span></div>`}).join("");return`<div class="scoreboard__wrap"><div class="scoreboard__title">High Scores</div>${t}${n}</div>`}function ge(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function ye(e){const t=new Date(e),n=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0");return`${n}-${s}-${i} ${r}:${o}`}const ve=document.getElementById("board"),Se=document.getElementById("next"),be=document.getElementById("hold"),Ie=document.getElementById("score"),we=document.getElementById("level"),Ce=document.getElementById("lines"),E=document.getElementById("btn-pause"),Te=document.getElementById("btn-restart"),G=document.getElementById("scoreboard"),Ee={board:ve,next:Se,hold:be,scoreEl:Ie,levelEl:we,linesEl:Ce},m=new V;m.attach();const f=q();let g=!1,H=f.status;E.addEventListener("click",()=>Z());Te.addEventListener("click",()=>{K(f),g=!1,E.textContent="Pause"});function Z(){g=!g,E.textContent=g?"Resume":"Pause"}function Me(){if(m.consume("pause")&&Z(),m.consume("restart")&&(K(f),g=!1,E.textContent="Pause"),g||f.status!=="playing")return;const e=m.consume("left"),t=m.consume("right");e&&I(f,-1,0),t&&I(f,1,0),m.consume("softDrop")&&I(f,0,1),m.consume("rotateCW")&&k(f,1),m.consume("rotateCCW")&&k(f,-1),m.consume("hardDrop")&&oe(f),m.consume("hold")&&re(f)}const Le=new Q({update:e=>{Me(),g||ie(f,e),H!==f.status&&(f.status==="gameover"&&De(),H=f.status)},render:()=>ce(f,Ee)});Le.start();const _e="https://chbibdnqynilfuczbygg.supabase.co",xe="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoYmliZG5xeW5pbGZ1Y3pieWdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MDc0OTQsImV4cCI6MjA3MDI4MzQ5NH0.VuwTKXiU1Yx4C_fQCIp5X20m8SupxBkCKhQzN7Vqe20";window.__SUPABASE__={url:_e,anonKey:xe};Y(G,S());function De(){const e=f.score,t=S();if(he(e,t)){const n=localStorage.getItem("tetris_player_name")??"",s=prompt("New High Score! Enter your name:",n??""),i=s&&s.trim()?s.trim():n||"Anonymous";try{localStorage.setItem("tetris_player_name",i)}catch{}pe(i,e,{level:f.level,lines:f.lines})}Y(G,S())}
