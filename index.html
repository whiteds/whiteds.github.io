<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>세븐나이츠 리버스 쿠폰 자동 입력</title>
    
    <!-- Tabulator CSS -->
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .input-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            resize: vertical;
            min-height: 150px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .status-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        
        .status-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #4caf50;
            transition: width 0.3s;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 12px;
        }
        
        #result-table {
            margin-top: 20px;
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .failure {
            color: #dc3545;
            font-weight: bold;
        }
        
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>세븐나이츠 리버스 쿠폰 자동 입력</h1>
        
        <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
            <strong>⚠️ CORS 문제 해결 방법:</strong>
            <ol style="margin: 10px 0 0 20px;">
                <li>브라우저 확장 프로그램 사용: "Allow CORS" 또는 "CORS Unblock" 확장 설치</li>
                <li>프록시 서버 사용: 아래 드롭다운에서 프록시 옵션 선택</li>
                <li>로컬 서버 실행: Python의 http.server 또는 Node.js의 http-server 사용</li>
                <li>Chrome 보안 비활성화: --disable-web-security 플래그로 Chrome 실행 (개발용)</li>
            </ol>
        </div>
        
        <div class="input-section">
            <div class="form-group">
                <label for="userId">사용자 ID (UID):</label>
                <input type="text" id="userId" placeholder="게임 내 UID를 입력하세요">
            </div>
            
            <div class="form-group">
                <label for="proxyOption">CORS 우회 방법:</label>
                <select id="proxyOption" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; margin-bottom: 15px;">
                    <option value="direct">직접 호출 (CORS 에러 가능)</option>
                    <option value="cors-anywhere">cors-anywhere.herokuapp.com 프록시</option>
                    <option value="allorigins">api.allorigins.win 프록시</option>
                    <option value="custom">커스텀 프록시 URL</option>
                </select>
                <input type="text" id="customProxy" placeholder="커스텀 프록시 URL 입력 (예: https://your-proxy.com/)" style="display: none; margin-bottom: 15px;">
            </div>
            
            <div class="form-group">
                <label for="couponList">쿠폰 코드 목록 (한 줄에 하나씩):</label>
                <textarea id="couponList" placeholder="쿠폰 코드를 입력하세요&#10;예시:&#10;COUPON1234&#10;COUPON5678&#10;COUPON9012">RINKARMA
GUILDWAR
7SENASENA7
GOODLUCK
THANKYOU
LOVELYRUBY
REBIRTHBACK
BONVOYAGE
YONGSANIM
TREASURE
WELCOMEBACK
THEMONTHOFSENA
EVANKARIN
DARKKNIGHTS
SENAHAJASENA
CMMAY
7777777
LOVESENA
INFINITETOWER
UPDATES
SENARAID
SENAEVENTS
SECRETCODE
MAILBOX
YUISSONG
RELEASEPET
MOREKEYS
WELCOMESENA
HEROSOMMON
SENAREGOGO
SHOWMETHEMONEY
PDKIMJUNGKI
INFOCODEX
THEHOLYCROSS
FUSEGETSPECIAL
ADVENTURER
NOHOSCHRONICLE
VALKYRIE
LEGENDSRAID
STORYEVENT
SURPRISE
INTOTHESENA
FORTAGNIA
JJOLJACK
PUKIDANCE
777SENARE
SEVENVSDARK
HTRIBERANES
JULYSENAMONTH
LODING
SADENDING
SHININGPRISM
MOONLIGHTCOAST</textarea>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="saveResults" checked> 등록 결과 자동 저장
                </label>
            </div>
            
            <div class="button-group">
                <button class="btn-primary" onclick="startCouponRegistration()">쿠폰 등록 시작</button>
                <button class="btn-secondary" onclick="loadPreviousResults()">이전 결과 불러오기</button>
                <button class="btn-secondary" onclick="clearResults()">결과 초기화</button>
                <button class="btn-secondary" onclick="clearSavedData()">저장 데이터 삭제</button>
            </div>
        </div>
        
        <div class="status-section" id="statusSection" style="display: none;">
            <div class="status-info">
                <span>진행 상황: <span id="currentProgress">0</span> / <span id="totalCoupons">0</span></span>
                <span>성공: <span id="successCount" class="success">0</span> | 실패: <span id="failureCount" class="failure">0</span></span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>
        
        <div id="result-table"></div>
    </div>
    
    <!-- Tabulator JS -->
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    
    <script>
        // 쿠키 관리 함수
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
        }
        
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
        
        // 로컬 스토리지 키
        const STORAGE_KEY = 'skr_coupon_results';
        const UID_KEY = 'skr_saved_uids';
        
        // 데이터 저장 함수
        function saveResultsToStorage(userId, results) {
            try {
                // 기존 데이터 불러오기
                const existingData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                
                // 사용자별 결과 저장
                if (!existingData[userId]) {
                    existingData[userId] = {};
                }
                
                // 결과 병합 (새로운 결과로 덮어쓰기)
                results.forEach(result => {
                    existingData[userId][result.coupon] = {
                        status: result.status,
                        message: result.message,
                        timestamp: result.timestamp
                    };
                });
                
                // 저장
                localStorage.setItem(STORAGE_KEY, JSON.stringify(existingData));
                
                // UID 목록 저장
                const uids = JSON.parse(localStorage.getItem(UID_KEY) || '[]');
                if (!uids.includes(userId)) {
                    uids.push(userId);
                    localStorage.setItem(UID_KEY, JSON.stringify(uids));
                }
                
                return true;
            } catch (error) {
                console.error('데이터 저장 실패:', error);
                return false;
            }
        }
        
        // 이전 결과 불러오기
        function loadPreviousResults() {
            const userId = document.getElementById('userId').value.trim();
            if (!userId) {
                alert('먼저 사용자 ID를 입력해주세요!');
                return;
            }
            
            try {
                const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                const userResults = savedData[userId];
                
                if (!userResults) {
                    alert('해당 사용자 ID의 저장된 결과가 없습니다.');
                    return;
                }
                
                // 테이블 초기화 및 데이터 표시
                table.clearData();
                const tableData = [];
                let index = 1;
                
                // 현재 쿠폰 목록 가져오기
                const currentCoupons = document.getElementById('couponList').value.split('\n').filter(c => c.trim());
                
                currentCoupons.forEach(coupon => {
                    const trimmedCoupon = coupon.trim();
                    if (userResults[trimmedCoupon]) {
                        const result = userResults[trimmedCoupon];
                        tableData.push({
                            index: index++,
                            coupon: trimmedCoupon,
                            status: result.status,
                            message: result.message,
                            timestamp: result.timestamp
                        });
                    }
                });
                
                if (tableData.length > 0) {
                    table.setData(tableData);
                    document.getElementById('statusSection').style.display = 'block';
                    
                    // 통계 업데이트
                    const successCount = tableData.filter(r => r.status === '성공').length;
                    const failureCount = tableData.filter(r => r.status === '실패' || r.status === '오류').length;
                    
                    document.getElementById('currentProgress').textContent = tableData.length;
                    document.getElementById('totalCoupons').textContent = currentCoupons.length;
                    document.getElementById('successCount').textContent = successCount;
                    document.getElementById('failureCount').textContent = failureCount;
                    
                    updateProgressBar(tableData.length, currentCoupons.length);
                    
                    alert(`${tableData.length}개의 이전 결과를 불러왔습니다.`);
                } else {
                    alert('현재 쿠폰 목록에 해당하는 저장된 결과가 없습니다.');
                }
            } catch (error) {
                console.error('데이터 불러오기 실패:', error);
                alert('저장된 데이터를 불러오는 중 오류가 발생했습니다.');
            }
        }
        
        // 저장된 데이터 삭제
        function clearSavedData() {
            if (confirm('모든 저장된 데이터를 삭제하시겠습니까?')) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(UID_KEY);
                alert('저장된 데이터가 모두 삭제되었습니다.');
            }
        }
        
        // 마지막 결과 자동 로드
        function autoLoadLastResults() {
            const savedUserId = getCookie('skr_user_id');
            if (!savedUserId) return;
            
            try {
                const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                const userResults = savedData[savedUserId];
                
                if (!userResults || Object.keys(userResults).length === 0) return;
                
                // 테이블 데이터 준비
                const tableData = [];
                let index = 1;
                
                // 현재 쿠폰 목록 가져오기
                const currentCoupons = document.getElementById('couponList').value.split('\n').filter(c => c.trim());
                
                currentCoupons.forEach(coupon => {
                    const trimmedCoupon = coupon.trim();
                    if (userResults[trimmedCoupon]) {
                        const result = userResults[trimmedCoupon];
                        tableData.push({
                            index: index++,
                            coupon: trimmedCoupon,
                            status: result.status,
                            message: result.message,
                            timestamp: result.timestamp
                        });
                    }
                });
                
                if (tableData.length > 0) {
                    table.setData(tableData);
                    document.getElementById('statusSection').style.display = 'block';
                    
                    // 통계 업데이트
                    const successCount = tableData.filter(r => r.status === '성공').length;
                    const failureCount = tableData.filter(r => r.status === '실패' || r.status === '오류').length;
                    
                    document.getElementById('currentProgress').textContent = tableData.length;
                    document.getElementById('totalCoupons').textContent = currentCoupons.length;
                    document.getElementById('successCount').textContent = successCount;
                    document.getElementById('failureCount').textContent = failureCount;
                    
                    updateProgressBar(tableData.length, currentCoupons.length);
                }
            } catch (error) {
                console.error('자동 로드 실패:', error);
            }
        }
        
        // 페이지 로드 시 저장된 사용자 ID 불러오기
        window.onload = function() {
            const savedUserId = getCookie('skr_user_id');
            if (savedUserId) {
                document.getElementById('userId').value = savedUserId;
            }
            
            // 프록시 옵션 변경 이벤트
            document.getElementById('proxyOption').addEventListener('change', function() {
                const customProxyInput = document.getElementById('customProxy');
                if (this.value === 'custom') {
                    customProxyInput.style.display = 'block';
                } else {
                    customProxyInput.style.display = 'none';
                }
            });
            
            // 저장된 UID 목록 표시 (옵션)
            const savedUids = JSON.parse(localStorage.getItem(UID_KEY) || '[]');
            if (savedUids.length > 0) {
                console.log('저장된 UID 목록:', savedUids);
            }
            
            // 마지막 결과 자동 로드
            setTimeout(() => {
                autoLoadLastResults();
            }, 100);
        };
        
        // Tabulator 테이블 초기화
        let table = new Tabulator("#result-table", {
            data: [],
            layout: "fitColumns",
            columns: [
                {title: "순번", field: "index", width: 80},
                {title: "쿠폰 코드", field: "coupon", width: 200},
                {title: "결과", field: "status", formatter: function(cell) {
                    const value = cell.getValue();
                    let className = '';
                    if (value === '성공') className = 'success';
                    else if (value === '실패') className = 'failure';
                    else className = 'warning';
                    return `<span class="${className}">${value}</span>`;
                }},
                {title: "메시지", field: "message", tooltip: true},
                {title: "시간", field: "timestamp", width: 150}
            ],
        });
        
        // 쿠폰 등록 시작
        async function startCouponRegistration() {
            const userId = document.getElementById('userId').value.trim();
            const couponText = document.getElementById('couponList').value.trim();
            
            if (!userId) {
                alert('사용자 ID를 입력해주세요!');
                return;
            }
            
            if (!couponText) {
                alert('쿠폰 코드를 입력해주세요!');
                return;
            }
            
            // 사용자 ID 저장
            setCookie('skr_user_id', userId, 30);
            
            // 쿠폰 목록 파싱
            const coupons = couponText.split('\n').filter(coupon => coupon.trim() !== '');
            
            // 상태 섹션 표시
            document.getElementById('statusSection').style.display = 'block';
            document.getElementById('totalCoupons').textContent = coupons.length;
            
            // 테이블 초기화
            table.clearData();
            
            let successCount = 0;
            let failureCount = 0;
            const allResults = [];
            
            // 이전 결과 확인
            const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            const userResults = savedData[userId] || {};
            
            // 쿠폰 등록 처리
            for (let i = 0; i < coupons.length; i++) {
                const coupon = coupons[i].trim();
                
                // 진행 상황 업데이트
                document.getElementById('currentProgress').textContent = i + 1;
                updateProgressBar(i + 1, coupons.length);
                
                // 이미 성공한 쿠폰 확인
                if (userResults[coupon] && userResults[coupon].status === '성공') {
                    const skipData = {
                        index: i + 1,
                        coupon: coupon,
                        status: '성공',
                        message: '이미 등록된 쿠폰 (건너뜀)',
                        timestamp: userResults[coupon].timestamp
                    };
                    
                    table.addData([skipData]);
                    allResults.push(skipData);
                    successCount++;
                    document.getElementById('successCount').textContent = successCount;
                    
                    await sleep(100); // 빠르게 건너뜀
                    continue;
                }
                
                try {
                    // 쿠폰 등록 API 호출 (실제 API 엔드포인트로 변경 필요)
                    const result = await registerCoupon(userId, coupon);
                    
                    if (result.success) {
                        successCount++;
                        document.getElementById('successCount').textContent = successCount;
                    } else {
                        failureCount++;
                        document.getElementById('failureCount').textContent = failureCount;
                    }
                    
                    // 결과 객체 생성
                    const resultData = {
                        index: i + 1,
                        coupon: coupon,
                        status: result.success ? '성공' : '실패',
                        message: result.message,
                        timestamp: new Date().toLocaleTimeString()
                    };
                    
                    // 테이블에 결과 추가
                    table.addData([resultData]);
                    allResults.push(resultData);
                    
                } catch (error) {
                    failureCount++;
                    document.getElementById('failureCount').textContent = failureCount;
                    
                    const errorData = {
                        index: i + 1,
                        coupon: coupon,
                        status: '오류',
                        message: error.message,
                        timestamp: new Date().toLocaleTimeString()
                    };
                    
                    table.addData([errorData]);
                    allResults.push(errorData);
                }
                
                // 잠시 대기 (서버 부하 방지)
                await sleep(500);
            }
            
            // 결과 저장 (옵션이 체크되어 있는 경우)
            if (document.getElementById('saveResults').checked) {
                const saved = saveResultsToStorage(userId, allResults);
                if (saved) {
                    console.log('결과가 자동으로 저장되었습니다.');
                }
            }
            
            alert(`쿠폰 등록 완료!\n성공: ${successCount}개\n실패: ${failureCount}개`);
        }
        
        // 쿠폰 등록 API 호출
        async function registerCoupon(userId, coupon) {
            try {
                const proxyOption = document.getElementById('proxyOption').value;
                const baseUrl = `https://coupon.netmarble.com/api/coupon/reward?gameCode=tskgb&couponCode=${coupon}&langCd=KO_KR&pid=${userId}`;
                let url;
                
                switch (proxyOption) {
                    case 'direct':
                        url = baseUrl;
                        break;
                    case 'cors-anywhere':
                        url = `https://cors-anywhere.herokuapp.com/${baseUrl}`;
                        break;
                    case 'allorigins':
                        url = `https://api.allorigins.win/get?url=${encodeURIComponent(baseUrl)}`;
                        break;
                    case 'custom':
                        const customProxy = document.getElementById('customProxy').value.trim();
                        if (!customProxy) {
                            return {
                                success: false,
                                message: '커스텀 프록시 URL을 입력해주세요.'
                            };
                        }
                        url = customProxy + baseUrl;
                        break;
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                let data;
                if (proxyOption === 'allorigins') {
                    const proxyResponse = await response.json();
                    data = JSON.parse(proxyResponse.contents);
                } else {
                    data = await response.json();
                }
                
                // API 응답에 따른 처리
                if (data.result === 0 || data.resultCode === '0000') {
                    return {
                        success: true,
                        message: data.resultMessage || '쿠폰이 성공적으로 등록되었습니다.'
                    };
                } else if (data.errorCode === 24004) {
                    // errorCode 24004: 해당 쿠폰의 교환 횟수를 초과하였습니다 - 성공으로 처리
                    return {
                        success: true,
                        message: '이미 사용된 쿠폰입니다. (교환 횟수 초과)'
                    };
                } else {
                    return {
                        success: false,
                        message: data.resultMessage || data.errorMessage || '쿠폰 등록에 실패했습니다.'
                    };
                }
            } catch (error) {
                // CORS 에러나 네트워크 오류 처리
                console.error('쿠폰 등록 오류:', error);
                return {
                    success: false,
                    message: 'API 호출 중 오류가 발생했습니다. CORS 정책으로 인해 직접 호출이 제한될 수 있습니다.'
                };
            }
        }
        
        // 진행률 바 업데이트
        function updateProgressBar(current, total) {
            const percentage = Math.round((current / total) * 100);
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percentage + '%';
            progressFill.textContent = percentage + '%';
        }
        
        // 결과 초기화
        function clearResults() {
            table.clearData();
            document.getElementById('statusSection').style.display = 'none';
            document.getElementById('currentProgress').textContent = '0';
            document.getElementById('totalCoupons').textContent = '0';
            document.getElementById('successCount').textContent = '0';
            document.getElementById('failureCount').textContent = '0';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressFill').textContent = '0%';
        }
        
        // 대기 함수
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>